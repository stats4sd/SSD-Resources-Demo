<!-- <link rel="import" href="../polymer/polymer-element.html"> -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="resource-editor">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
      }
    </style>

    <!-- Firebase binding for live tag data -->
    <firebase-document path="/tags" data="{{liveTags}}" app-name="SSD-Resources"></firebase-document>
    <firebase-document id="currentTag" app-name="SSD-Resources" data="{{currentTag}}" path=""></firebase-document>

    <!-- Title and Description -->
    <paper-input id="resourceName" value="{{resource.name}}" name="title" label="Title of Resource" required></paper-input>
    <span class="url">[[origin]]/[[slug]]</span>
    <p>
      <paper-textarea id="resourceDescription" value="{{resource.description}}" name="description" label="Brief Description" required
        always-float-label></paper-textarea>
    </p>

    <!-- *** Need save function to track tags saved, possibly linked to combo change event to populate resource tags -->

    <!-- Tags -->
    <vaadin-combo-box label="Keywords" id="Keywords_Combo" items="[[_computeItems(liveTags,'Keywords')]]" item-value-path="key"
      allow-custom-value on-custom-value-set="_addNewTag" on-change="_comboChange">
    </vaadin-combo-box>
    <template id="keywordsList" is="dom-repeat" as="tag" items="[[_tagsToArray(resource.tags,'Keywords')]]">
      <paper-button class="tag-button">{{tag.label}}
        <iron-icon icon="close" on-tap="removeTag"></iron-icon>
      </paper-button>
    </template>

    <vaadin-combo-box label="Resource Type" id="Resource-Types_Combo" items="[[_computeItems(liveTags,'Resource-Types')]]" item-value-path="key"
      on-change="_comboChange">
    </vaadin-combo-box>

    <!-- **************************** possibly manage collections elsewhere? ************************ -->

    <!-- External Links -->
    <h4>External Links</h4>
    <template id="externalLinks" is="dom-repeat" items="[[resource.externalLinks]]" as="link">
      <div class='flex-container'>
        <a href="{{link.url}}" target="_blank"><span>[[link.url]]</span></a>
        <paper-icon-button suffix on-tap="editLink" class="green" icon="mode-edit" alt="edit" title="edit">
        </paper-icon-button>
        <paper-icon-button on-tap="removeLink" class="red" icon="clear" alt="clear" title="clear">
        </paper-icon-button>
      </div>
    </template>
    <div class="flex">
        <iron-icon icon="public" prefix></iron-icon>
        <paper-input style="flex-basis:100%" label="add external links here" no-label-float value="{{externalLinkUrl}}"></paper-input>
        <paper-icon-button suffix on-tap="_addExternalLink" style="color:green" icon="add" alt="add" title="add" ></paper-icon-button>
    </div>
    
      
      
    </paper-input>

    <!-- Draft/Published Checkbox -->
    <div class="flex">
      <paper-toggle-button checked="{{!resource.draft}}"></paper-toggle-button>
      <div hidden$="[[resource.draft]]">
        <span>Public</span>
        <iron-icon icon="visibility"></iron-icon>
      </div>
      <div hidden$="[[!resource.draft]]">
        <span>Draft</span>
        <iron-icon icon="visibility-off"></iron-icon>
      </div>
    </div>



    
    <h4>Uploaded Files</h4>
    <vaadin-upload id="ssdResourceUpload" on-upload-before="fileupload" files="[[resource.uploadedFiles]]"></vaadin-upload>
    <iron-icon slot="drop-label-icon" icon="description"></iron-icon>
    <span slot="drop-label"></span>
    <div class="delete" on-tap="delete">
      <paper-icon-button icon="delete" class="delete-button"></paper-icon-button>
      <span>Delete Resource</span>
    </div>

    <h4>Feature Image</h4>
    <div class='flex-container'>
      <iron-selector>
          <div on-tap="setFeatureImage">
            <img src="[[_getFeatureImage(resource.tags)]]" style="max-width:200px">
          </div>
        </template>
      </iron-selector>
    </div>
  </template>

  <script>
    /**
     * `resource-editor`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ResourceEditor extends Polymer.Element {
      static get is() { return 'resource-editor'; }
      static get properties() {
        return {
          slug: {
            type: String,
            computed: '_toSlug(resource.name)'
          },
          origin: {
            type: String,
            value: function () { return window.origin + '/resource' }
          },
          externalLinkUrl:{
            type:String,
            value:''
          }
        };
      }
      _toSlug(name) {
        if (!name) {
          //new resource
          this.resource.slug = ""
          return ""
        }
        else {
          //could definitely be combined into one expression but I suck at regex :( 
          //make lower case, replace all spaces with '-' and remove special
          var slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^0-9a-z-]/g, "");
          this.resource.slug = slug
          return slug
        }
      }
      _computeItems(tags, key) {
        // take liveTags, select subset and put into correct format (un-nest json)
        let items = tags[key]
        let temp = []
        for (let key in items) {
          let t = items[key]
          t.key = key
          temp.push(t)
        }
        return temp
      }

      _addNewTag(e) {
        let type = e.target.id.split('_')[0]
        let label = e.target.filter
        let tag = {
          type: type,
          label: label,
          modified: Date.now(),
          slug: this._toSlug(label),
          key: this.generatePushID()
        }
        console.log('saving tag', tag)
        let path = "/tags/" + type
        this.set('currentTag', tag)
        this.$.currentTag.saveValue(path, tag.key).then(function () {
          //populate element
          this.updateResourceTags(tag.key, this.currentTag, type)
          this.$.currentTag.reset()
        }.bind(this));
      }

      removeTag(e) {
        // remove keyword tag bound to resource
        // to generalise see older versions, or look at binding to e.target for info
        var key = e.model.tag.key
        delete this.resource.tags.Keywords[key]
        //dirty override as doesn't detect when all tags removed
        let tags = this.resource.tags
        this.set('resource.tags', {})
        this.set('resource.tags', tags)
      }
      _comboChange(e) {
        // Use combo box change event to populate resource tag. Tracks which field to populate by taking all before '_' in id name
        // If no item available then used to create new
        let item = e.target.selectedItem
        let type = e.target.id.split('_')[0]
        if (type == "Keywords") { e.target.value = "" }
        // if no item tag will be added through add new tag function called on combo custom value set
        if (!item) { return }
        let key = item.key
        this.updateResourceTags(key, item, type)
      }
      updateResourceTags(key, value, type) {
        if (!this.resource.hasOwnProperty('tags')) { this.resource.tags = {} }
        if (!this.resource.tags.hasOwnProperty(type)) { this.resource.tags[type] = {} }
        // override previous resource types if exist (tag unique only for resource types)
        if (type == "Resource-Types") { this.resource.tags['Resource-Types'] = {} }
        this.resource.tags[type][key] = value
        // attempts to get keywords list to update and resource type image to render
        let tags = this.resource.tags
        this.set('resource.tags', {})
        this.set('resource.tags', tags)
      }
      _addExternalLink(e) {
        if(!this.resource.externalLinks){
          this.set('resource.externalLinks',[])
          }
        if (this.externalLinkUrl != '') {
          this.push('resource.externalLinks', {
            displayName: "",
            url: this.externalLinkUrl
          })
        }
        this.set('externalLinkUrl', "")        
        console.log('resource', this.resource)
      }
      removeLink(e) {
        var index = e.model.index;
        this.splice('resource.externalLinks', index, 1)
      }
      editLink(e) {
        this.set('externalLinkUrl', e.model.link.url)  
        this.removeLink(e)
      }
      _getFeatureImage(tags){
        if(this.resource.featureImageUrl){return this.resource.featureImageUrl}
        console.log('getting feature image',tags)
        if(tags.hasOwnProperty('Resource-Types')){
          let key = Object.keys(tags['Resource-Types'])[0]
          let url = '/images/resourceTypes/'+tags['Resource-Types'][key].slug+'.jpg'
          return url
        }
        else{
          return "/images/resourceTypes/fallback-image.jpg"
        }
      }
      _tagsToArray(json, subProperty) {
        //lookup full tag
        if (!json.hasOwnProperty(subProperty)) { return }
        let tags = json[subProperty]
        var tagsArray = []
        for (var key in tags) {
          if (tags.hasOwnProperty(key)) {
            tagsArray.push(tags[key])
          }
        }
        return tagsArray
      }
      fileupload(event) {
        event.preventDefault();
        //check resource name exists, give warning and remove files if not
        //*******not implemented yet*****

        //create file upload task
        let file = event.detail.file;
        let ssdResourcesApp = firebase.app("SSD-Resources")
        let ref = firebase.storage(ssdResourcesApp).ref().child('/resources/' + this.resource.$key + "/" + file.name)
        let uploadTask = ref.put(file);
        //handle updates from snapshot
        uploadTask.on('state_changed', function (snapshot) {
          let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          let vaadinUploads = document.querySelector('vaadin-upload')
          let index = this.getCurrentIndex(file.name)
          let temp = this.resource.uploadedFiles[index]
          temp.progress = progress
          this.set('resource.uploadedFiles.' + index, [])
          this.set('resource.uploadedFiles.' + index, temp)
        }.bind(this), function (error) {
          console.log('error', error)
          // Handle unsuccessful uploads
        }, function () {
          let index = this.getCurrentIndex(file.name);
          console.log('index',index)
          console.log('res',this.resource.uploadedFiles)
          let res = this.resource.uploadedFiles[index]
          console.log('res',res)
          let temp = {
            lastModified: res.lastModified,
            name: res.name,
            size: res.size,
            type: res.type,
            url: uploadTask.snapshot.downloadURL,
            complete: true,
            formDataName: "file",
            progress: 100,
          }
          this.set('resource.uploadedFiles.' + index, [])
          this.set('resource.uploadedFiles.' + index, temp)
          console.log('resource',this.resource)
        }.bind(this));
      }
      getCurrentIndex(fileName) {
        var uploads = this.resource.uploadedFiles
        for (var i = 0; i < uploads.length; i++) {
          if (uploads[i].name == fileName) { return i }
        }
      }
      generatePushID() {
        var PUSH_CHARS = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';
        var lastPushTime = 0;
        var lastRandChars = [];
        var now = new Date().getTime();
        var duplicateTime = (now === lastPushTime);
        lastPushTime = now;
        var timeStampChars = new Array(8);
        for (var i = 7; i >= 0; i--) {
          timeStampChars[i] = PUSH_CHARS.charAt(now % 64);
          now = Math.floor(now / 64);
        }
        if (now !== 0) throw new Error('We should have converted the entire timestamp.');
        var id = timeStampChars.join('');
        if (!duplicateTime) {
          for (i = 0; i < 12; i++) {
            lastRandChars[i] = Math.floor(Math.random() * 64);
          }
        } else {
          for (i = 11; i >= 0 && lastRandChars[i] === 63; i--) {
            lastRandChars[i] = 0;
          }
          lastRandChars[i]++;
        }
        for (i = 0; i < 12; i++) {
          id += PUSH_CHARS.charAt(lastRandChars[i]);
        }
        if (id.length != 20) throw new Error('Length should be 20.');
        return id;
      }
    }

    window.customElements.define(ResourceEditor.is, ResourceEditor);
  </script>
</dom-module>