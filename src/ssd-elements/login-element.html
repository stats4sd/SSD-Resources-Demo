<link rel="import" href="../../bower_components/polymer/polymer-element.html">


<dom-module id="login-element">
  <template>
      <style>
    :host {
      display: block;
      margin: 0 auto;
      padding:10px;
    }
    firebase-auth{
      display: none;
    }
    #reset{
      color: grey;
      text-decoration: none;
      font-size: 12px;
      font-style: italic;
      font-weight: lighter;
    }
    #reset:hover{
      color: grey;
      text-decoration: underline;
    }
    .emailPWError {
      color: var(--error-color);
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      line-height: 24px;
      margin: 0;
      padding: 0;
    }
    .emailPWMessage {
      color: var(--primary-color);
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      line-height: 24px;
      margin: 0;
      padding: 0;
    }
    form{
      min-width: 200px;
      margin: 0 auto;
    }
  </style>

  <firebase-auth app-name="{{appName}}" id="auth" user="{{user}}" signed-in="{{signedIn}}" on-error="_handleEmailPWError" status-known="{{statusKnown}}">
    </firebase-auth>
  
    <div>
      <div id="emailPWError"></div>
      <div id="emailPWMessage"></div>
    </div>
    <form id="loginForm" on-submit="_signInEmailPW">
      <paper-input id="emailInput" type="email" label="Email" value="{{email}}" validator="email-validator" error-message="Invalid email address" required auto-validate></paper-input>
      <paper-input id="pwInput" type="password" label="Password" value="{{pw}}" on-keypress="_checkEnter" required></paper-input>
      <p><a href="#" id="reset" on-click="_resetPW">Reset password for entered email</a></p>
      <!--<paper-button id="emailSignUp" type="submit" on-tap="_signUpEmailPW">Sign Up</paper-button>-->
      <!-- <paper-button id="emailSignIn" type="submit" on-tap="_signInEmailPW" dialog-confirm autofocus>Sign In</paper-button> -->
      <paper-button id="emailSignIn" type="submit" on-tap="_signInEmailPW" autofocus>Sign In</paper-button>
      <paper-button id="emailSignIn" type="submit" dialog-confirm autofocus>Cancel</paper-button>
      <paper-spinner-lite id="spinner" alt="Signing In" active></paper-spinner-lite>
    </form>

  </template>

  <script>
    /**
     * `login-element`
     * small adaptation of email-login-fire element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class LoginElement extends Polymer.Element {
      static get is() { return 'login-element'; }
      static get properties() {
        return {
          appName: {
            type: String
          },
          user: {
            type: Object,
            notify: true,
            reflectToAttribute: true,
            observer:'_userChanged'
          },
          signedIn: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true
          },
          debug: {
            type: Boolean,
            value: false,
          },
          passwordResetMessage: {
            type: String,
            value:  "Password reset email has been sent. Please check your inbox."
          },
          autoSignUp: {
            type: Boolean,
            value: false
          },
          statusKnown: {
            type: Boolean,
            notify: true
          },
          email:{
            type:String
          },
          pw:{
            type:String
          },
          spinnerActive:{
            type:Boolean,
            value:false,
            reflectToAttribute:true
          }
        };
      }
      // _userChanged: function(u){
      //   if(typeof u !== 'undefined' && u != null){
      //     if (!(Object.keys(u).length === 0 && u.constructor === Object)){
      //       this.fire("signedin", u);
      //     }
      //   }
      // },
      _cleanMessages(){
        this.$.emailPWError.textContent = '';
        this.$.emailPWMessage.textContent = '';
      }

      _signInEmailPW(e){
        this._cleanMessages();
        this.spinnerActive=true      
        this.$.loginForm.querySelector('paper-spinner-lite, paper-spinner').active=true
        this.$.auth.signInWithEmailAndPassword(this.email, this.pw)
          .then(function(success){
          })
          .catch(function(error){
          })
      }

      _userChanged(user){
        this.$.loginForm.querySelector('paper-spinner-lite, paper-spinner').active=false
      }

      // _signUpEmailPW(e){
      //   this._cleanMessages();
      //   this.$.auth.createUserWithEmailAndPassword(this.email, this.pw);
      // }

      _handleEmailPWError(err){
        this.pw = null;
        this.$.emailPWError.textContent = err.detail.message;
        this.$.loginForm.querySelector('paper-spinner-lite, paper-spinner').active=false
      }

      // _handleEmailPWError(err){
      //   if(err.detail.code === "auth/user-not-found" && this.autoSignUp){
      //     this.$.auth.createUserWithEmailAndPassword(this.email, this.pw)
      //     this.email = null;
      //     this.pw = null;
      //   } else {
      //     this.$.emailPWError.textContent = err.detail.message;
      //   }
      // }

      // _resetPW() {
      //   var that = this;
      //   this._cleanMessages();
      //   if(this.email){
      //     this.$.auth.sendPasswordResetEmail(this.email).then(function () {
      //       that.$$(".emailPWMessage").textContent = that.passwordResetMessage;
      //     }, function (err) {
      //       that.$$(".emailPWError").textContent = err.message;
      //     });
      //   } else {
      //     this.$.emailPWError.textContent = "Please enter a valid email address.";
      //   }
      // }

      /**
       * Signs out the signed in user
       */

      signOut(){
        if(this.signedIn){this.$.auth.signOut();}
      }

      //function to check for 'enter' keypress on password field.
      _checkEnter(e) {
        if(e.keyCode === 13) {
          this._signInEmailPW();
        }
      }
    }

    window.customElements.define(LoginElement.is, LoginElement);
  </script>
</dom-module>
