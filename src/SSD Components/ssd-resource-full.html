<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">

<link rel="import" href="../shared-styles.html">


<dom-module id="ssd-resource-full">
  <template>
  <template is="dom-if" if="[[!editable]]">
    <style include="shared-styles">
      .totallyEditable:hover {
        border: #3577f6 1px solid;
        background-color: #d3eaf6;
        cursor: pointer;
      }
      
      .editing {
        width: 90%;
        margin: 15px auto;
      }
      
      .fileDownload {
        display: inline-block;
        min-width: 220px;
        margin: 5px;
        padding: 0;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        background-color: rgba(0, 0, 0, 0.12);
        border-radius: 5px;
        text-decoration: none;
        color: black;
      }
      
      .fileDownload:hover {
        background-color: #3645af;
        cursor: pointer;
      }
    </style>
    <div class="card">
      <p>Here is the selected resource</p>
      <h3>[[resource.name]]</h3>
      <p><span class='bold'>Description: </span>[[resource.description]]</p>
      <ul>
        <li>
          <span class='bold'>Topics: </span>
          <template is="dom-repeat" items="[[resource.topics]]" as="topic">
            <span>[[topic]]; </span>
          </template>
        </li>
        <li>
          <span class='bold'>Resource Type(s): </span>
          <template is="dom-repeat" items="[[resource.rTypes]]" as="rType">
            <span>[[rType]]; </span>
          </template>
        </li>
        <li>
          <span class='bold'>Tags: </span>
          <template is="dom-repeat" items="[[resource.tags]]" as="tag">
            <span>[[tag]]; </span>
          </template>
        </li>
      </ul>
      <h4>Files:</h4>
      <p>Click on any of the file cards to download it</p>
      <template is='dom-repeat' items="[[_toArray(resource.uploadedFiles)]]" as="file">
        <a class='fileDownload' href="[[file.value.url]]">
          <p style="margin-bottom:2px">[[file.value.name]]</p>
          <ul>
            <li>
              <h5 style="margin:2px">Size = [[toMb(file.value.size)]]</h5>
            </li>
            <li>
              <h5 style="margin:2px">Uploaded date = [[toDateString(file.value.lastModified)]]</h5>
            </li>
          </ul>
        </a>
      </template>
    </div>
  </template>

  <!-- NOW FOR THE EDITABLE VERSION -->
  <template is="dom-if" if="[[editable]]">
    <div class="card editing" id$="[[resourceId]]">
      <h1>ID = [[resourceId]]</h1>
      <paper-input id="resourceName" value="{{name}}" name="title" label="Title of Resource" required auto-validate pattern="[a-zA-Z0-9 ']*"
        error-message="no special characters!"></paper-input>
      <paper-textarea id="resourceDescription" value="{{description}}" name="description" label="Brief Description" required></paper-textarea>
      <br>
      <paper-tabs selected="{{tabSelected}}">
        <paper-tab>Topics</paper-tab>
        <paper-tab>Collections</paper-tab>
        <paper-tab>Type</paper-tab>
        <paper-tab>Tags</paper-tab>
      </paper-tabs>
      <br>
      <iron-pages selected="{{tabSelected}}">
        <div>
          <div class='list-group'>
            <div class='list-group-item-heading'>All Topics</div>
            <template is="dom-repeat" id="topicCheckboxes" items="[[persistedTopics]]" as="topic">
              <div class='list-group-item'>
                <paper-checkbox id$="topics_-_[[topic.$val]]" value="topics_-_[[topic.$val]]" checked="[[_checked(topics, topic.$val)]]"
                  on-change="checkTopic">[[topic.$val]]</paper-checkbox>
              </div>
            </template>
          </div>
        </div>
        <div>
          <div class='list-group'>
            <template is="dom-repeat" id="collectionCheckboxes" items="[[persistedCollections]]" as="collection">
              <div class='list-group-item'>
                <paper-checkbox value="collections_-_[[collection.$val]]" checked="[[_checked(collections, collection.$val)]]" on-change="checkCollection">{{collection.$val}}</paper-checkbox>
              </div>
            </template>
          </div>
        </div>
        <div>
          <div class='list-group'>
            <template is="dom-repeat" id="rTypeCheckboxes" items="[[persistedRTypes]]" as="rType">
              <div class='list-group-item'>
                <paper-checkbox value="rTypes_-_[[rType.$val]]" checked="[[_checked(rTypes, rType.$val)]]" on-change="checkrType">{{rType.$val}}</paper-checkbox>
              </div>
            </template>
          </div>
        </div>
        <div>
          <div class='list-group'>
            <template is="dom-repeat" id="tagCheckboxes" items="[[persistedTags]]" as="tag">
              <div class='list-group-item'>
                <paper-checkbox value="tags_-_[[tag.$val]]" checked="[[_checked(tags, tag.$val)]]" on-change="checkTag">{{tag.$val}}</paper-checkbox>
              </div>
            </template>
          </div>
        </div>
      </iron-pages>
      <br><br>
      <p>Pin to upcoming events?</p>
      <paper-checkbox value="events_-_RM Workshop Kenya">RM Workshop Kenya</paper-checkbox>
    </div>
    <div class='card editing'>
      <h3>Uploaded Files</h3>
      <ul>
        <template is="dom-repeat" id="fileView" items="[[_toArray(uploadedFiles)]]" as="file">
          <a class='fileDownload' href="[[file.value.url]]">
            <li>
              <h5 style="margin-bottom:2px">[[file.value.name]]</h5>
              <ul>
                <li>Size = [[toMb(file.value.size)]]; </li>
                <li>Uploaded date = [[toDateString(file.value.lastModified)]]</li>
              </ul>
            </li>
          </a>

        </template>
      </ul>
      <h3>Add new files</h3>
      <vaadin-upload id="ssdResourceUpload" on-upload-before="fileupload"></vaadin-upload>
    </div>

    <firebase-document id="firebaseDocSingleFile" app="SSD-Resources" app-name="SSD-Resources" path="[[fileId]]" data="{{singleFile}}"></firebase-document>

    <script>
      function _getCurrentIndex(file, uploadsMeta) {
        var index = -1
        for (var i = 0; i < uploadsMeta.length; i++) {
          var name = uploadsMeta[i].name
          if (file.name == name) {
            index = i
          }
        }
        return index;
      }
    </script>


  </template>

</template>
<script>
  Polymer({
    is: 'ssd-resource-full',
    properties: {
      resource:{
        type:Object,
        value:[]
      },
      name: {
        type: String,
        notify: true
      },
      description: {
        type: String,
        notify: true
      },
      topics: {
        type: Array,
        notify: true
      },
      rTypes: {
        type: Array,
        notify: true
      },
      tags: {
        type: Array,
        notify: true
      },
      collections: {
        type: Array,
        notify: true
      },
      editable: {
        type: Boolean,
        reflectToAttribute: true,
        value: false
      },
      tabSelected: {
        value: 0
      },
      persistedTopics: {
        type: Array,
        notify: true
      },
      uploadedFiles: {
        type: Array,
        notify: true
      },
      editingFile: {
        Type: Array,
        notify: true
      },
      fileId: {
        Type: String,
        notify: true
      },
      singleFile: {
        type: Object,
        notify: true
      },
      resourceId: {
        type: String,
        notify: true
      }
    },

    _toArray: function (obj) {
      if (obj) {
        var array = Object.keys(obj).map(function (key) {
          return {
            name: key,
            value: obj[key]
          };
        });
        console.log(array);
        return array;
      }
      else {
        return [];
      }

    },

    toMb: function (size) {
      //if less than 1MB, return size in kB
      var val;

      if (size * 0.000001 < 1) {
        val = Math.round(size * 0.001)
        return val + "KB";
      }
      else {
        val = Math.round(size * 0.000001)
        return val + "MB";
      }
    },

    toDateString: function (milliseconds) {
      var updated = (new Date(milliseconds)).toISOString().slice(0, 10);

      return updated;
    },
    //
    // filePath: function(resourceId, fileId) {
    //   return resourcdId + "/uploadedFiles/" + fileId;
    // },


    _checked: function (topics, topic) {
      console.log(topic)
      console.log(topics)
      if (topics.indexOf(topic) != -1) {
        return true;
        console.log("checked-true");
      }
      else {
        console.log("checked-false")
        return false;
      }
    },

    checkTopic: function (e) {
      var selected = document.getElementById("topicCheckboxes").itemForElement(e.srcElement)
      if (e.srcElement.checked == true) {
        if (this.topics) {
          this.push("topics", selected.$val)
        }
        else {
          this.topics = [selected.$val]
        }

      }
      else {
        var index = this.topics.indexOf(selected.$val)
        this.splice("topics", index, 1);
      }
    },

    checkCollection: function (e) {
      var selected = document.getElementById("collectionCheckboxes").itemForElement(e.srcElement)
      if (e.srcElement.checked == true) {
        if (this.collections) {
          this.push("collections", selected.$val)
        }
        else {
          this.collections = [selected.$val]
        }
      }
      else {
        var index = this.collections.indexOf(selected.$val)
        this.splice("collections", index, 1);
      }
    },

    checkrType: function (e) {
      var selected = document.getElementById("rTypeCheckboxes").itemForElement(e.srcElement)
      if (e.srcElement.checked == true) {
        if (this.rTypes) {
          this.push("rTypes", selected.$val)
        }
        else {
          this.rTypes = [selected.$val]
        }
      }
      else {
        var index = this.rTypes.indexOf(selected.$val)
        this.splice("rTypes", index, 1);
      }
    },

    checkTag: function (e) {
      var selected = document.getElementById("tagCheckboxes").itemForElement(e.srcElement)
      if (e.srcElement.checked == true) {
        if (this.tags) {
          this.push("tags", selected.$val)
        }
        else {
          this.tags = [selected.$val]
        }
      }
      else {
        var index = this.tags.indexOf(selected.$val)
        this.splice("tags", index, 1);
      }
    },

    fileupload: function (event) {
      event.preventDefault();
      //check resource name exists, give warning and remove files if not

      //create file upload task
      var file = event.detail.file;
      console.log(file)
      var ssdResourcesApp = firebase.app("SSD-Resources")
      console.log(ssdResourcesApp)
      filenumber = this._toArray(this.uploadedFiles).length;
      console.log(filenumber)

      var ref = firebase.storage(ssdResourcesApp).ref().child(this.resourceId + '/' + filenumber + "/" + file.name)
      console.log(ref)
      var uploadTask = ref.put(file);
      uploadTask.on('state_changed', function (snapshot) {
        var progressBars = document.querySelectorAll('paper-progress');
        console.log(progressBars);
        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        var vaadinUploads = document.querySelector('vaadin-upload')
        console.log(vaadinUploads)
        var uploadsMeta = vaadinUploads.get('files');
        var index = _getCurrentIndex(file, uploadsMeta)
        console.log(index)
        progressBars[index].set('value', progress)
      }, function (error) {
        console.log(error)
        // Handle unsuccessful uploads
      }, function () {
        console.log('uploadTask', uploadTask)
        var downloadURL = uploadTask.snapshot.downloadURL;
        // //set progress bar to complete
        var vaadinUploads = document.querySelector('vaadin-upload')
        var uploadsMeta = vaadinUploads.get('files');
        console.log(uploadsMeta);
        console.log(vaadinUploads);
        var vaadinFiles = document.querySelectorAll('vaadin-upload-file')
        var index = _getCurrentIndex(file, uploadsMeta)
        vaadinFiles[index].set('file.complete', true);
        vaadinFiles[index].set('file.loaded', 100);

        // just pushing the new file item to the uploadedFiles array loses a bunch of the file metadata (I guess the perils of forcing a file object into a database array?)  So - terrible hack time:
        var fileItem = [];
        fileItem.name = vaadinUploads.files[index].name;
        fileItem.lastModified = Date.now();
        fileItem.size = vaadinUploads.files[index].size;
        fileItem.url = downloadURL;
        console.log(fileItem);

        document.querySelector("#activeResource").newFile(fileItem);


      });
      this.$.fileView.render();
    },

    statechanged: function (event) {
      console.log(event.detail.file);
    },

    newFile: function (fileItem) {
      //if no uploadedFiles yet, create and set property.
      console.log(this.name);

      if (!this.uploadedFiles) {
        this.set("uploadedFiles", [])
        console.log("no uploaded files, so created empty array");
        console.log(this.uploadedFiles)
      }
      console.log(fileItem);
      console.log(document.querySelector("#firebaseDocSingleFile"));

      this.fileId = null;
      var path = this.resourceId + "/uploadedFiles/";
      console.log(path);
      this.singleFile = fileItem
      return document.querySelector("#firebaseDocSingleFile").save(path).then(function () {
        console.log("singleFile = " + this.singleFile)
        console.log("singleFileId = " + this.fileId);
        document.querySelector("#firebaseDocSingleFile").reset();
      }.bind(this));
    },

    // saveFile: function() {
    //   return this.$.editingResource.save("/resources").then(function() {
    //     this.$.editingResource.reset();
    //   }.bind(this));
    // }



  })
</script>
</dom-module>