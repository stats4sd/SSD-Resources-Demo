<!--import polymer html and shared styles-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="ssd-components/admin-tag.html">

<!--imported via imports-lazy-resources.html or imports-core-html-->
<!--  
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">



<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

-->


<!--give id reference of page name-->
<dom-module id="ssd-tags">
  <!-- topicS -->
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
        background-color:#ccc;
      }

      paper-card {
        padding: 0 15px;
        /*max-width: 400px;*/
        min-width: 500px;
        display: inline-block;
        margin-bottom: 25px;
      }

      admin-tags {
        min-width: 450px;
      }

      #currentTagMaker {
        background-color: green;
        margin-left: 10px;
        margin-bottom: 20px;
      }
    </style>

    <paper-card heading="List of Existing Tags">
      <!-- Selection determines which tag is loaded in from the firebase-document (only for deletions. All other edits are made via the 2-way link to the firebase-query.)  -->
      <paper-menu selected="{{currentTagId}}" attr-for-selected="name">
        <template id="resourceList" is="dom-repeat" items="{{allTags}}" as="tag">
          <admin-tag name="{{tag.$key}}" tag='{{tag}}' on-delete="deleteTag"></admin-tag>
        </template>
      </paper-menu>
      <paper-button raised id='currentTagMaker' on-tap='openNewTag'>Add new tag</paper-button>
      <admin-tag id="newTagElement" tag='{{currentTag}}' on-delete="deleteTag" on-save="saveNew" hidden$="{{!editingNew}}"></admin-tag>
    </paper-card>


    <!-- Firebase query to list all tags in the database -->
    <firebase-query id="query" app-name="SSD-Resources" path="/tags" data="{{allTags}}"></firebase-query>


    <firebase-document id="currentTag" app-name="SSD-Resources" data="{{currentTag}}" path="/tags/{{currentTagId}}">
    </firebase-document>

  </template>


  <script>
//give element selector name here
    Polymer({
      is: 'ssd-tags',
      properties:{
        uid:String,
        allTags:{
          type:Object,
        },
        emptyTagNoteOpen:{
          type:Boolean,
          value:false
        },
        currentTag:{
          type:Object,
        },
        editingNew:{
          type:Boolean,
          value:false,
        }
      },

      observers: [
        '_currentTagTagChanged(currentTag.*)',
        '_allTagsChanged(allTags.*)'
      ],

      _currentTagTagChanged: function() {
        // console.log("Current Tag Changed Observe:", this.currentTag)
      },

      _allTagsChanged: function() {
        // console.log("All Tags Changed",this.allTags);
      },


      closeNote: function() {
        this.set("emptyTagNoteOpen",false);
        console.log(this.emptyTagNoteOpen)
      },

      openNewTag: function() {
        //first, set current TagID to null so we're not overwriting anything through the firebase-document
        this.currentTagId = "";
        //then make the currentTag empty, so it's ready for new stuff
        this.currentTag = {};
        // then make the newTagElement visible AND set it to editing mode.
        this.editingNew = true;
        this.$.newTagElement.editing = true;
      },

      //submitTag function to send whatever's in the currentTag object off to the database.  This either overwrites a tag at id = currentTag.id, or (if id is not specified) creates a new entry in the database.
      saveNew: function() {
        console.log("currentTag",this.currentTag);


        //set modified date
        this.currentTag.modified = Date.now()

        // save new tag
        this.$.currentTag.save('/tags').then(function () {
          console.log("firebase-doc",this.$.currentTag.path)
          console.log("currentTag",this.currentTag)

          //set ID of currentTag based on newly generated Path:
          //this.set("currentTag.id",id);

          //finally, discardTag:
          this.currentTagId = "";
          //and hide the newTag editor:
          this.$.currentTag.reset()
          this.editingNew = false;

        }.bind(this));

      },

      deleteTag: function() {

        //the currentTag is set to whichever tag is currently selected from the list. So making it null removes it from the db.
        this.currentTag = null;
        console.log("Event worked, deleting...");
        // call a reset on the firebase-document.
        this.currentTagId = "";

        this.editingNew = false;

      }


    });
  </script>
</dom-module>
