<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">


<dom-module id="ssd-resource-editor">
  <template>
    <style include="shared-styles">
      paper-tabs {
        --paper-tabs-selection-bar-color: blue
      }

      .delete {
        margin-top: 1em;
        cursor: pointer;
      }

      .keywordSelected {}
    </style>
    <style is="custom-style">
      paper-checkbox {
        display: block
      }

      paper-icon-button.delete-button {
        color: var(--paper-red-500)
      }

      paper-tags-dropdown {
        --paper-menu: {
          width: 200px;
        }
      }

      .flex-container {
        display: flex
      }

      .image-label {
        display: block
      }

      .url {
        font-size: x-small
      }
      .feature-image{
        display: inline-block
      }

    </style>
    <style is="custom-style">
      paper-icon-button.red {
        color: var(--paper-red-500);
        --paper-icon-button-ink-color: var(--paper-red-500);
      }

      paper-icon-button.green {
        color: var(--paper-green-700);
        --paper-icon-button-ink-color: var(--paper-green-700);
      }

      paper-button.tag-button {
        border: 2px solid black;
        padding: 0;
        margin: 0;
        text-transform: none;
      }
      .iron-selected {
          border: 2px solid black;
        }
    </style>

    <paper-input id="resourceName" value="{{resource.name}}" name="title" label="Title of Resource" required></paper-input>
    <span class="url">[[origin]]/[[slug]]</span>
    <p>
      <paper-textarea id="resourceDescription" value="{{resource.description}}" name="description" label="Brief Description" required></paper-textarea>
    </p>
    <!-- REPLACED PAPER TABS WITH PAPER TAGS -->

    <h4>Tags</h4>
    <!--<paper-tags-dropdown items="[[_filterTags(persistedTags,'Topic')]]" label="Topics" id-accessor="$key" value-object="{{resource.topics}}"></paper-tags-dropdown>
    <paper-tags-dropdown items="[[_filterTags(persistedTags,'Collection')]]" label="Collections" id-accessor="$key" value-object="{{resource.collections}}"></paper-tags-dropdown>
    <paper-tags-dropdown items="[[_filterTags(persistedTags,'Keyword')]]" label="Keywords" id-accessor="$key" value-object="{{resource.keywords}}"></paper-tags-dropdown>-->

    <vaadin-combo-box label="Resource Types" id="Resource-TypeCombo" items="[[_filterTags(persistedTags,'Resource-Type')]]" selected-item="{{tags.Resource-Type}}"
      filtered-items="{{filteredResource-Type}}" on-change="_comboChange" on-filter-changed="_filterChanged" focused="{{focused.Resource-Type}}"
      item-value-path="$key" item-value-path="label" allow-custom-value>
    </vaadin-combo-box>
    <div hidden$="[[!newTag]]" on-tap="addTag">
      <div hidden$="[[!focused.Resource-Type]]">Press enter to add tag: [[newTag.label]]</div>
    </div>
    <template is="dom-repeat" as="tag" items="[[_tagsToArray(resource.tags,'Resource-Type')]]" observe="tags resource.tags">
      <paper-button class="tag-button">{{tag.label}}
        <iron-icon icon="close" on-tap="removeTag"></iron-icon>
      </paper-button>
    </template>

    <vaadin-combo-box label="Collections" id="CollectionCombo" items="[[_filterTags(persistedTags,'Collection')]]" selected-item="{{tags.Collection}}"
      filtered-items="{{filteredCollections}}" on-change="_comboChange" on-filter-changed="_filterChanged" focused="{{focused.Collection}}"
      item-value-path="$key" item-value-path="label" allow-custom-value>
    </vaadin-combo-box>
    <div hidden$="[[!newTag]]" on-tap="addTag">
      <div hidden$="[[!focused.Collection]]">Press enter to add tag: [[newTag.label]]</div>
    </div>
    <template is="dom-repeat" as="tag" items="[[_tagsToArray(resource.tags,'Collection')]]" observe="tags resource.tags">
      <paper-button class="tag-button">{{tag.label}}
        <iron-icon icon="close" on-tap="removeTag"></iron-icon>
      </paper-button>
    </template>

    <!--<paper-tags id="Resource-TypeTags" items="[[_tagsToArray(resource.tags,'Resource-Type')]]"></paper-tags>-->
    <!--live tag editor-->
    <firebase-document id="currentTag" app-name="SSD-Resources" data="{{currentTag}}" path="/tags/"></firebase-document>
    <firebase-document id="allTags" app-name="SSD-Resources" data="{{allTags}}" path="/tags"></firebase-document>


    <h4>External Links</h4>
    <template id="externalLinks" is="dom-repeat" items="[[resource.externalLinks]]" as="link">
      <!--{{link.number}} test-->
      <div class='flex-container'>
        <a href="{{link.url}}" target="_blank"><span>[[link.url]]</span></a>
        <paper-icon-button suffix on-tap="editLink" class="green" icon="editor:mode-edit" alt="edit" title="edit">
        </paper-icon-button>
        <paper-icon-button on-tap="removeLink" class="red" icon="clear" alt="clear" title="clear">
        </paper-icon-button>
      </div>
    </template>

    <paper-input label="add any external links here" no-label-float value="{{resource.tempLinkUrl}}">
      <iron-icon icon="language" prefix></iron-icon>
      <paper-icon-button suffix on-tap="addLink" class="green" icon="add" alt="add" title="add" hidden$="{{link.saved}}">
      </paper-icon-button>
    </paper-input>

    <h4>Uploaded Files</h4>
    <vaadin-upload id="ssdResourceUpload" on-upload-before="fileupload" files="[[resource.uploadedFiles]]"></vaadin-upload>
    <div class="delete" on-tap="delete">
      <paper-icon-button icon="delete" class="delete-button"></paper-icon-button>
      <span>Delete Resource</span>
    </div>

    <h4>Feature Image</h4>
    <div class='flex-container'>
    <iron-selector>
      <template is="dom-repeat" as="tag" items="[[_tagsToArray(resource.tags,'Resource-Type')]]" observe="tags resource.tags">
        <div on-tap="setFeatureImage" class="feature-image">
          <img src="/images/resourceTypes/{{tag.slug}}.jpg">
          <div class="image-label">{{tag.label}}</div>
        </div>
      </template>
    </iron-selector>
    </div>


  </template>

  <script>
    Polymer({
      is: 'ssd-resource-editor',
      properties: {

        editing: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
        editMode: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        filtered: {
          type: Object,
          value: {}
        },
        focused: {
          type: Object,
          value: {},
        },
        tabSelected: {
          value: 0
        },
        uploadedFiles: {
          type: Array,
          notify: true
        },
        editingFile: {
          Type: Array,
          notify: true
        },
        fileId: {
          Type: String,
          notify: true
        },
        singleFile: {
          type: Object,
          notify: true
        },
        resourceId: {
          type: String,
          notify: true
        },
        slug: {
          type: String,
          computed: '_toSlug(resource.name)'
        },
        opened: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },
        liveTagsPath: {
          type: String,
          value: "",
          notify: true
        },
        deleted: {
          type: Boolean,
          value: false,
          notify: true
        },
        newLink: {
          type: Object,
          value: {
            url: '',
            displayName: ''
          },
          currentTagId: {
            type: String,
            value: ''
          },
          currentTag: {
            type: Object
          },
        }



      },
      ready: function () {
        this.origin = window.location.origin;
        //needs to match vaadin elements for proper lookup
        this.tagTypes = [
          { type: 'Resource-Type', label: 'Resource Types' },
          { type: 'Collection', label: 'Collections' },
          { type: 'Keyword', label: 'Keywords' }
        ]
        console.log('tag types', this.tagTypes)
      },

      _filterTags: function (tags, filter) {
        filteredTags = tags.filter(function (e) {
          return e.type == filter;
        })
        return filteredTags;
      },
      //function to lookup tag metadata and filter for resource tag type
      //replaces paper-tags value-object lookup functionality as moving away from component
      _tagsToArray: function (tags, filter) {
        //lookup full tag
        var tagsArray = []
        for (var key in tags) {
          if (tags.hasOwnProperty(key)) {
            if (tags[key] == filter) {
              tagsArray.push(this._lookupTag(key))
            }
          }
        }
        return tagsArray
      },
      _lookupTag: function (key) {
        //iterate over persisted tags, return matching key
        for (var i = 0; i < this.persistedTags.length; i++) {
          if (this.persistedTags[i].$key == key) {
            return this.persistedTags[i]
          }
        }
        //no tag found, probably deleted
        return {
          label: 'TAG NOT FOUND',
          $key: key
        }
      },
      _comboChange: function (e) {
        console.log('combo change', e.target.value, e.target.label)
        var type = this._getTagType(e.target.label)
        console.log('type looked up:', type)
        this.updateResourceTags(e.target.value, type)
        e.target.value = ""
      },
      //lookup tag label and return tag type
      _getTagType: function (val) {
        console.log('getting type for', val)
        for (var key in this.tagTypes) {
          if (this.tagTypes.hasOwnProperty(key)) {
            if (this.tagTypes[key].label == val) { return this.tagTypes[key].type }
          }
        }
      },

      //runs usual filter function (not updating filtered items),
      //but tracks whether none exist to populate add tag button
      //messy workarounds as unfocus sets text to "" and want to not hide tag
      _filterChanged: function (e) {
        //work out which filter
        this.currentFilter = this._getFocusedFilter();
        if (this.currentFilter == undefined) {
          this.newTag = false
          return
        }
        var filterText = e.detail.value.toLowerCase()
        var items = this.$$('#' + this.currentFilter + 'Combo').items
        var focused = this.$$('#' + this.currentFilter + 'Combo').focused

        if (!items) { items = [] }
        var filtered = items.filter(function (el) {
          var label = el.label.toLowerCase()
          return label.indexOf(filterText) !== -1;
        })
        if (filtered.length == 0 && focused) {
          this.newTag = {
            label: filterText,
            type: this.currentFilter
          }
        }
        if (filterText == "" && focused) { this.newTag = false }
        if (filtered.length > 0 && focused) { this.newTag = false }
        // console.log('filtered', filtered)
        // console.log('filterText', filterText)
        // console.log('focused', focused)
        // console.log('this.focused', this.focused)
      },
      addTag: function () {
        this.currentTag = this.newTag
        this.currentTag.modified = Date.now()
        this.currentTag.slug = this._toSlug(this.currentTag.label)
        // save new tag
        var key = this.generatePushID()
        this.currentTag.key = key;
        this.$.currentTag.save('/tags', key).then(function () {
          //finally, discardTag:
          console.log('tag saved', this.newTag)
          //populate element
          this.updateResourceTags(key, this.currentTag.type)
          this.newTag = false
          this.$.currentTag.reset()

        }.bind(this));
      },
      removeTag: function (e) {
        console.log('removing tag', e.model.tag)
        var key = e.model.tag.$key
        delete this.resource.tags[key]
        // this.notifyPath('resource.tags')
        //dirty override as doesn't detect when all tags removed
        var temp = this.resource
        this.resource = {}
        this.resource = temp
      },
      updateResourceTags: function (key, value) {
        console.log('updating resource tag', key)
        console.log('new tag?', this.newTag)
        if (this.newTag != false) {
          console.log('need to add tag')
          this.addTag()
          return
        }
        console.log('no need to add tag')
        if (!this.resource.tags) { this.resource.tags = {} }
        this.resource.tags[key] = value
        //dirty override as doesn't update after more than one tag
        //this.notifyPath('resource.tags')
        var temp = this.resource.tags
        this.set('resource.tags',[])
        this.set('resource.tags',temp)
        console.log('resource',this.resource)
      },
      _toSlug: function (name) {
        if (!name) {
          //new resource
          this.resource.slug = ""
          return ""
        }
        else {
          //could definitely be combined into one expression but I suck at regex :( 
          //make lower case, replace all spaces with '-' and remove special
          var slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^0-9a-z-]/g, "");
          this.resource.slug = slug
          return slug
        }
      },
      _getFocusedFilter: function () {
        for (var key in this.focused) {
          if (this.focused.hasOwnProperty(key)) {
            if (this.focused[key] == true) { return key }
          }
        }
        //if none focused return last known
        return this.currentFilter
      },

      setFeatureImage: function (e) {
        var tag = e.model.tag
        this.resource.featureImage = "/images/resourceTypes/" + tag.slug + ".jpg"
        console.log('this.resource', this.resource)
      },

      addLink: function (e) {
        if(!this.resource.externalLinks){
          this.set('resource.externalLinks',[])
          }
        if (this.resource.tempLinkUrl != '') {
          this.push('resource.externalLinks', {
            displayName: "",
            url: this.resource.tempLinkUrl
          })
        }
        this.set('resource.tempLinkUrl', "")        
        console.log('resource', this.resource)
      },
      editLink: function (e) {
        this.newLink = e.model.link
        this.removeLink(e)
      },
      removeLink: function (e) {
        var index = e.model.index;
        this.splice('resource.externalLinks', index, 1)

      },
      isHidden: function (link) {
        console.log('hidden?', link)
        if (link.saved == true) { return true }
        if (link.url == "") { return true }
        return false
      },

      fileupload: function (event) {
        event.preventDefault();
        //check resource name exists, give warning and remove files if not
        //*******not implemented yet*****

        //create file upload task
        var file = event.detail.file;
        var ssdResourcesApp = firebase.app("SSD-Resources")
        var ref = firebase.storage(ssdResourcesApp).ref().child('/resources/' + this.resource.$key + "/" + file.name)
        var uploadTask = ref.put(file);
        //handle updates from snapshot
        uploadTask.on('state_changed', function (snapshot) {
          var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          var vaadinUploads = document.querySelector('vaadin-upload')
          var index = this.getCurrentIndex(file.name)
          var temp = this.resource.uploadedFiles[index]
          temp.progress = progress
          this.set('resource.uploadedFiles.' + index, [])
          this.set('resource.uploadedFiles.' + index, temp)
        }.bind(this), function (error) {
          console.log('error', error)
          // Handle unsuccessful uploads
        }, function () {
          var index = this.getCurrentIndex(file.name);
          res = this.resource.uploadedFiles[index]
          temp = {
            lastModified: res.lastModified,
            name: res.name,
            size: res.size,
            type: res.type,
            url: uploadTask.snapshot.downloadURL,
            complete: true,
            formDataName: "file",
            progress: 100,
          }
          this.set('resource.uploadedFiles.' + index, [])
          this.set('resource.uploadedFiles.' + index, temp)
          console.log('resource',this.resource)
        }.bind(this));
      },

      //iterate through each uplaod to find index of current filename
      getCurrentIndex: function (fileName) {
        var uploads = this.resource.uploadedFiles
        for (var i = 0; i < uploads.length; i++) {
          if (uploads[i].name == fileName) { return i }
        }
      },
      delete: function (e, detail) {
        console.log('delete clicked')
        this.set('deleted', true)
      },
      _toArray: function (obj) {
        if (obj) {
          var array = Object.keys(obj).map(function (key) {
            return {
              name: key,
              value: obj[key]
            };
          });
          console.log(array);
          return array;
        }
        else {
          return [];
        }

      },
      //firebase function taken from https://gist.github.com/mikelehen/3596a30bd69384624c11
      generatePushID: function () {
        var PUSH_CHARS = '-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz';
        var lastPushTime = 0;
        var lastRandChars = [];
        var now = new Date().getTime();
        var duplicateTime = (now === lastPushTime);
        lastPushTime = now;
        var timeStampChars = new Array(8);
        for (var i = 7; i >= 0; i--) {
          timeStampChars[i] = PUSH_CHARS.charAt(now % 64);
          now = Math.floor(now / 64);
        }
        if (now !== 0) throw new Error('We should have converted the entire timestamp.');
        var id = timeStampChars.join('');
        if (!duplicateTime) {
          for (i = 0; i < 12; i++) {
            lastRandChars[i] = Math.floor(Math.random() * 64);
          }
        } else {
          for (i = 11; i >= 0 && lastRandChars[i] === 63; i--) {
            lastRandChars[i] = 0;
          }
          lastRandChars[i]++;
        }
        for (i = 0; i < 12; i++) {
          id += PUSH_CHARS.charAt(lastRandChars[i]);
        }
        if (id.length != 20) throw new Error('Length should be 20.');
        return id;
      },
      hideEmptyReourceNoteOpen: function () {
        this.emptyReourceNoteOpen = false;
      },
      //simple random alpha-numeric generator
      //doesn't check for duplicates
      generateShortCode: function () {
        var text = "";
        var possible = "ABCDEFGHIJKLMNPQRSTUVWXYZabcdefghijklmnpqrstuvwyz123456789";
        for (var i = 0; i < 4; i++)
          text += possible.charAt(Math.floor(Math.random() * possible.length));
        return text;
      },
    })
  </script>
</dom-module>