<!--See form docs at: https://elements.polymer-project.org/elements/iron-form-->

<!--import polymer html and shared styles-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="shared-styles.html">

<!--give id reference of page name-->
<dom-module id="ssd-add-resource">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      paper-material {
        display: inline-block;
        background: white;
        box-sizing: border-box;
        width: 100%;
        margin: 8px;
        padding: 16px;
        border-radius: 2px;
      }

      paper-progress {
        width: 100%
      }
    </style>

    <paper-material elevation="1">
      <!-- <form method="get" action="/" id="basic" onsubmit="event.preventDefault()"> -->
        <paper-input id='title' label="Title" required auto-validate pattern="[a-zA-Z0-9 ']*" error-message="no special characters!"></paper-input>
        <div class='list-group'>
          <div class='list-group-item'>
            <div class='list-group-item-header'>
              <p>Selected Topics:</p>
              <template is="dom-repeat" items="{{topicAdd}}" as="topic">
                <p>Topic: {{topic}}</p>
              </template>
              <paper-button value='topics' on-tap='_toggleTags'>Add / Remove Topics</paper-button>
            </div>
            <iron-collapse id="topics">
              <h2>Topics</h2>
              <template is="dom-repeat" items="[[persistedTopics]]" as="topic">
                <paper-checkbox name="{{topic.$val}}" collection="topic" on-checked-changed="_updateCollection">{{topic.$val}}</paper-checkbox>
              </template>
            </iron-collapse>
          </div>
          <div class='list-group-item'>
            <paper-button class="" raised on-tap="_toggleTags" value="rTypes">Add Resource Type(s)</paper-button>
            <iron-collapse id="rTypes">
              <h2>Resource Types</h2>
              <template is="dom-repeat" items="[[persistedrTypes]]" as="rType">
                <paper-checkbox name="{{rType.$val}}" collection="rType" on-checked-changed="_updateCollection">{{rType.$val}}</paper-checkbox>
              </template>
            </iron-collapse>
          </div>
          <div class='list-group-item'>
            <paper-button class="clear"  raised on-tap="_toggleTags" value="collections">Add Collections</paper-button>
            <iron-collapse id="collections">
              <h2>Collections</h2>
              <template is="dom-repeat" items="[[persistedCollections]]" as="collection">
                <paper-checkbox name="{{collection.$val}}" collection="collection" on-checked-changed="_updateCollection">{{collection.$val}}</paper-checkbox>
              </template>
            </iron-collapse>
          </div>
          <div class='list-group-item'>
            <paper-button class="clear"  raised on-tap="_toggleTags" value="otherTags">Add Other Tags</paper-button>
            <iron-collapse id="otherTags">
              <h2>Other Tags</h2>
              <template is="dom-repeat" items="[[persistedTags]]" as="tag">
                <paper-checkbox name="{{tag.$val}}" collection="tags" on-checked-changed="_updateCollection">{{tag.$val}}</paper-checkbox>
              </template>
            </iron-collapse>
          </div>
        </div>
      <!-- <vaadin-upload id="ssdResourceUpload"></vaadin-upload> -->
      <br>
      <paper-button raised on-tap="submit" >Submit</paper-button>
      <paper-button raised onclick="_reset(event)">Reset</paper-button>
      <div class="output">
      </div>
    <!-- </form> -->


    </paper-material>


    <firebase-query id="collectionsQuery" app-name="SSD-Resources" path="/collections" data="{{allCollections}}"></firebase-query>
    <app-indexeddb-mirror key="persistedCollections" data="{{allCollections}}" persisted-data="{{persistedCollections}}"></app-indexeddb-mirror>
    <firebase-query id="rTypesQuery" app-name="SSD-Resources" path="/rTypes" data="{{allrTypes}}"></firebase-query>
    <app-indexeddb-mirror key="persistedrTypes" data="{{allrTypes}}" persisted-data="{{persistedrTypes}}"></app-indexeddb-mirror>
    <firebase-query id="topicsQuery" app-name="SSD-Resources" path="/topics" data="{{allTopics}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTopics" data="{{allTopics}}" persisted-data="{{persistedTopics}}"></app-indexeddb-mirror>
    <firebase-query id="tagsQuery" app-name="SSD-Resources" path="/tags" data="{{allTags}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTags" data="{{allTags}}" persisted-data="{{persistedTags}}"></app-indexeddb-mirror>

    <!-- Firebase document to expose the resources : path to polymer databinding -->
    <firebase-query path="/resources" app-name="SSD-Resources" data="{{resources}}" id="resourceQuery"></firebase-query>
    <!-- <app-indexeddb-mirror key="persistedresources" data="{{resources}}" persisted-data="{{persistedresources}}"></app-indexeddb-mirror> -->


    <script>
  // function _submit(event) {
  //   Polymer.dom(event).localTarget.parentElement.submit();
  //   console.log('submitted')
  // }
  function _reset(event) {
    var form = Polymer.dom(event).localTarget.parentElement
    form.reset();
    form.querySelector('.output').innerHTML = '';
  }

  // hack around vaadin upload to use firebase file put
  // can be improved on with full rewrite of vaadin-upload
  var upload1 = document.querySelector('vaadin-upload#ssdResourceUpload');
  upload1.addEventListener('upload-before', function(event) {
    event.preventDefault();
    if(!this.myfiles){this.myFiles=[]}
    // if(document.getElementById('fileList')){document.getElementById('fileList').remove();}
    var file = event.detail.file;
    var index=this.myFiles.length
    this.myFiles.push(file)
    var ssdResourcesApp=firebase.app("SSD-Resources")
    var ref = firebase.storage(ssdResourcesApp).ref().child('uploads'+file.uploadTarget)
    var uploadTask=ref.put(file);
    uploadTask.on('state_changed',function(snapshot,i=index){
      var newIndex=i +this.myFiles.length-1
      var progressBars = document.querySelectorAll('paper-progress');
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      progressBars[newIndex].set('value',progress)
      switch (snapshot.state) {
        case firebase.storage.TaskState.PAUSED: // or 'paused'
          break;
        case firebase.storage.TaskState.RUNNING: // or 'running'
          break;
    }
  }.bind(this), function(error) {
    console.log(error)
    // Handle unsuccessful uploads
  }, function(success, i=index) {
    var newIndex=i +this.myFiles.length-1
    var vaadinFiles=document.querySelectorAll('vaadin-upload-file')
    vaadinFiles[newIndex].set('file.complete',true)
    var downloadURL = uploadTask.snapshot.downloadURL;
    }.bind(this));
    }.bind(this));


  </script>

  <script>
    this.checked={0:true,1:false}
   </script>
  </template>


  <script>

    Polymer({
      is: 'ssd-add-resource',
      properties:{
        items:{
          type:Object,
          observer:'itemChanged'
        },
        checked:{
          type:Object,
          observer:'checkChanged'
        },
        topicAdd:{
          type:Object,
          value: {}
        },
        rTypeAdd:{
          type:Object,
          value: {}
        },
        collectionAdd:{
          type:Object,
          value: {}
        },
        tagAdd:{
          type:Object,
          value: {}
        }
      },


      checkChanged:function(){console.log(this.checked)},
      itemChanged:function(e){console.log('items changed',this.items)},
      computeTopic:function(changeRecord) {
        return changeRecord
      },

      _toggleTags:function(e) {
        var section = e.srcElement.getAttribute("value");
        console.log(section);
        this.$[section].toggle();
      },

      _updateCollection:function(e) {
        var name = e.srcElement.name;
        console.log(name);
        console.log(this.allTopics)
        if(name) {
          var value = e.srcElement.checked;
          console.log(value);
          var collectionName = e.srcElement.getAttribute("collection");
          console.log(collectionName);
          collectionName +="Add";
          if(value==true){
            this.set(collectionName+"."+name,value)
          }
          else {
            delete this[collectionName][name];
          }
        }
        console.log(collectionName)
        console.log(this.topicDisplay)
        console.log(this[collectionName])
      },


      submit:function(){
        console.log('submitted')
      //this.querySelector('.output').innerHTML = JSON.stringify(event.detail);

        //create object to push to database
        console.log(this.$.resourceQuery.ref)
        console.log(this.$.title.value);
        console.log(this.collectionAdd);

         this.$.resourceQuery.ref.push({
          title : this.$.title.value ,
          collections : this.collectionAdd,
          topics : this.topicAdd,
          tags : this.tagAdd ,
          rTypes : this.rTypeAdd
         });
    }

    });
  </script>

</dom-module>
