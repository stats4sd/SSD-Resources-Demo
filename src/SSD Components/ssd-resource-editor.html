<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">

<link rel="import" href="../shared-styles.html">


<dom-module id="ssd-resource-editor">
  <template>
    <style include="shared-styles">
      paper-tabs {
        --paper-tabs-selection-bar-color: blue
      }
      .delete{
        margin-top: 1em;
        cursor:pointer;
      }
    </style>
    <style is="custom-style">
      paper-checkbox {
        display: block
      }
      paper-icon-button.delete-button {
        color: var(--paper-red-500)
      }
    </style>

    <paper-input id="resourceName" value="{{resource.name}}" name="title" label="Title of Resource" required auto-validate pattern="[a-zA-Z0-9 ']*"
      error-message="no special characters!"></paper-input>
    <p>
      <paper-textarea id="resourceDescription" value="{{resource.description}}" name="description" label="Brief Description" required></paper-textarea>
    </p>

    <paper-tabs selected="{{tabSelected}}">
      <paper-tab>Topics</paper-tab>
      <paper-tab>Collections</paper-tab>
      <paper-tab>Type</paper-tab>
      <paper-tab>Tags</paper-tab>
    </paper-tabs>
    <iron-pages selected="{{tabSelected}}">
      <paper-listbox multi attr-for-selected="value" selected-values="{{resource.topics}}">
        <template is="dom-repeat" items="[[persistedTopics]]" as="topic">
          <paper-item value="{{topic.$val}}">[[topic.$val]]</paper-item>
        </template>
      </paper-listbox>
      <paper-listbox multi attr-for-selected="value" selected-values="{{resource.collections}}">
        <template is="dom-repeat" items="[[persistedCollections]]" as="collection">
          <paper-item value="{{collection.$val}}">[[collection.$val]]</paper-item>
        </template>
      </paper-listbox>
      <paper-listbox multi attr-for-selected="value" selected-values="{{resource.rTypes}}">
        <template is="dom-repeat" items="[[persistedRTypes]]" as="rType">
          <paper-item value="{{rType.$val}}">[[rType.$val]]</paper-item>
        </template>
      </paper-listbox>
      <paper-listbox multi attr-for-selected="value" selected-values="{{resource.tags}}">
        <template is="dom-repeat" items="[[persistedTags]]" as="tag">
          <paper-item value="{{tag.$val}}">[[tag.$val]]</paper-item>
        </template>
      </paper-listbox>
    </iron-pages>

    <h3>Uploaded Files</h3>
    <vaadin-upload id="ssdResourceUpload" on-upload-before="fileupload" files="[[resource.uploadedFiles]]"></vaadin-upload>
    
    <div class="delete" on-tap="delete">
    <paper-icon-button icon="delete" class="delete-button"></paper-icon-button>
    <span>Delete Resource</span>
    </div>

  </template>


  <script>
    Polymer({
      is: 'ssd-resource-editor',
      properties: {

        editing: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
        editMode: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        tabSelected: {
          value: 0
        },
        uploadedFiles: {
          type: Array,
          notify: true
        },
        editingFile: {
          Type: Array,
          notify: true
        },
        fileId: {
          Type: String,
          notify: true
        },
        singleFile: {
          type: Object,
          notify: true
        },
        resourceId: {
          type: String,
          notify: true
        },
        opened: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },
        deleted:{
          type:Boolean,
          value:false,
          notify:true
        }

      },

      fileupload: function (event) {
        event.preventDefault();
        //check resource name exists, give warning and remove files if not
        //*******not implemented yet*****

        //create file upload task
        var file = event.detail.file;
        var ssdResourcesApp = firebase.app("SSD-Resources")
        var ref = firebase.storage(ssdResourcesApp).ref().child('/resources/' + this.resource.$key + "/" + file.name)
        var uploadTask = ref.put(file);
        //handle updates from snapshot
        uploadTask.on('state_changed', function (snapshot) {
          var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          var vaadinUploads = document.querySelector('vaadin-upload')
          var index = this.getCurrentIndex(file.name)
          var temp = this.resource.uploadedFiles[index]
          temp.progress = progress
          this.set('resource.uploadedFiles.' + index, [])
          this.set('resource.uploadedFiles.' + index, temp)
        }.bind(this), function (error) {
          console.log('error', error)
          // Handle unsuccessful uploads
        }, function () {
          var index = this.getCurrentIndex(file.name)
          let res= this.resource.uploadedFiles[index]
          let temp={
            lastModified:res.lastModified,
            name:res.name,
            size:res.size,
            type:res.type,
            url:uploadTask.snapshot.downloadURL,
            complete:true,
            formDataName:"file",
            progress:100,
          }
          this.set('resource.uploadedFiles.' + index, [])
          this.set('resource.uploadedFiles.' + index, temp)
        }.bind(this));
      },

      //iterate through each uplaod to find index of current filename
      getCurrentIndex: function (fileName) {
        var uploads=this.resource.uploadedFiles
        for (let i = 0; i < uploads.length; i++) {
          if (uploads[i].name == fileName) { return i }
        }
      },

      delete:function(e,detail){
        this.set('deleted',true)
      }
    })
  </script>
</dom-module>
