<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">

<link rel="import" href="../shared-styles.html">


<dom-module id="ssd-resource">
  <template>
    <template is="dom-if" if="[[!editable]]">
    <style include="shared-styles">
    .totallyEditable:hover {
      border: #3577f6 1px solid;
      background-color: #d3eaf6;
      cursor: pointer;
    }
    .editing {
      width: 90%;
      margin: 15px auto;
    }
    </style>
      <div class$="[[checkedView(view)]]">
        <h3>[[name]]</h3>
        <p><span class='bold'>Description: </span>[[description]]</p>
        <ul>
          <li>
            <span class='bold'>Topics: </span>
            <template is="dom-repeat" items="[[topics]]" as="topic">
              <span>[[topic]]; </span>
            </template>
          </li>
          <li>
            <span class='bold'>Resource Type(s): </span>
            <template is="dom-repeat" items="[[rTypes]]" as="rType">
              <span>[[rType]]; </span>
            </template>
          </li>
          <li>
            <span class='bold'>Tags: </span>
            <template is="dom-repeat" items="[[tags]]" as="tag">
              <span>[[tag]]; </span>
            </template>
          </li>
        </ul>
        <template is='dom-repeat' items="[[uploads]]" as="upload">
          <paper-button raised><a href="[[upload.downloadURL]]">DOWNLOAD FILE </paper-button>
        </template>
      </div>
    </template>

    <!-- NOW FOR THE EDITABLE VERSION -->
    <template is="dom-if" if="[[editable]]">
      <div class="card editing" id$="[[resourceId]]">
        <h1>ID = [[resourceId]]</h1>
        <paper-input id="resourceName" value="{{name}}" name="title" label="Title of Resource" required auto-validate pattern="[a-zA-Z0-9 ']*" error-message="no special characters!"></paper-input>
        <paper-textarea id="resourceDescription" value="{{description}}" name="description" label="Brief Description" required></paper-textarea>
        <br>
        <paper-tabs selected="{{tabSelected}}">
          <paper-tab>Topics</paper-tab>
          <paper-tab>Collections</paper-tab>
          <paper-tab>Type</paper-tab>
          <paper-tab>Tags</paper-tab>
        </paper-tabs>
        <br>
        <iron-pages selected="{{tabSelected}}">
          <div>
            <div class='list-group'>
              <div class='list-group-item-heading'>All Topics</div>
              <template is="dom-repeat" id="topicCheckboxes" items="[[persistedTopics]]" as="topic">
                <div class='list-group-item'>
                  <paper-checkbox id$="topics_-_[[topic.$val]]" value="topics_-_[[topic.$val]]" checked="[[_checked(topics, topic.$val)]]" on-change="checkTopic">[[topic.$val]]</paper-checkbox>
                </div>
              </template>
            </div>
          </div>
          <div>
            <div class='list-group'>
              <template is="dom-repeat" id="collectionCheckboxes" items="[[persistedCollections]]" as="collection">
                <div class='list-group-item'>
                  <paper-checkbox value="collections_-_[[collection.$val]]"  checked="[[_checked(collections, collection.$val)]]" on-change="checkCollection">{{collection.$val}}</paper-checkbox>
                </div>
              </template>
            </div>
          </div>
          <div>
            <div class='list-group'>
              <template is="dom-repeat" id="rTypeCheckboxes" items="[[persistedRTypes]]" as="rType">
                <div class='list-group-item'>
                  <paper-checkbox value="rTypes_-_[[rType.$val]]" checked="[[_checked(rTypes, rType.$val)]]" on-change="checkrType">{{rType.$val}}</paper-checkbox>
                </div>
              </template>
            </div>
          </div>
          <div>
            <div class='list-group'>
              <template is="dom-repeat" id="tagCheckboxes" items="[[persistedTags]]" as="tag">
                <div class='list-group-item'>
                  <paper-checkbox value="tags_-_[[tag.$val]]" checked="[[_checked(tags, tag.$val)]]" on-change="checkTag">{{tag.$val}}</paper-checkbox>
                </div>
              </template>
            </div>
          </div>
        </iron-pages>
        <br><br>
        <p>Pin to upcoming events?</p>
        <paper-checkbox value="events_-_RM Workshop Kenya">RM Workshop Kenya</paper-checkbox>
      </div>
      <div class='card editing'>
        <h2>File Uploads</h2>
        <vaadin-upload id="ssdResourceUpload" files="[[uploadedFiles]]" on-upload-before="fileupload" on-upload-progress="statechanged"></vaadin-upload>
      </div>

      <firebase-query id="allDocs" app-name="SSD-Resources" path="[[resourceId]]/uploadedFiles" data="{{uploadedFiles}}">
      </firebase-query>

      <firebase-document id="oneDoc" app-name="SSD-Resources" path="[[resourceId]]/uploadedFiles/[[fileId]]" data="{{editingFile}}"></firebase-document>
        <script>
      // function _submit(event) {
      //   Polymer.dom(event).localTarget.parentElement.submit();
      //   console.log('submitted')
      // }

      // hack around vaadin upload to use firebase file put
      // // can be improved on with full rewrite of vaadin-upload
      // var upload1 = document.querySelector('vaadin-upload#ssdResourceUpload');
      // console.log(upload1)
      // upload1.addEventListener('upload-before', function(event) {
      function _getCurrentIndex(file, uploadsMeta) {
        var index=-1
        for (var i=0;i<uploadsMeta.length;i++){
          var name=uploadsMeta[i].name
          if(file.name==name){
            index=i
          }
        }
        return index;
      }
      </script>


    </template>

  </template>
  <script>
    Polymer({
      is: 'ssd-resource',
      properties: {
        name: {
          type: String,
          notify: true
        },
        description: {
          type: String,
          notify: true
        },
        topics: {
          type: Array,
          notify: true
        },
        rTypes: {
          type: Array,
          notify: true
        },
        tags: {
          type: Array,
          notify: true
        },
        collections: {
          type: Array,
          notify: true
        },
        editable: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
        tabSelected:{
          value:0
        },
        persistedTopics:{
          type:Array,
          notify:true
        },
        uploadedFiles:{
          type:Array,
          notify:true
        },
        editingFile:{
          Type:Array,
          notify:true
        },
        fileId:{
          Type:String,
          notify:true
        }
      },

      checkedView: function(view) {
        if(view) {
          return "card totallyEditable"
        }
        else {
          return "card"
        }
      },

      _checked: function(topics, topic) {
        console.log(topic)
        console.log(topics)
        if(topics.indexOf(topic)!=-1) {
          return true;
          console.log("checked-true");
        }
        else {
          console.log("checked-false")
          return false;
        }
      },

      checkTopic: function(e) {
        var selected = document.getElementById("topicCheckboxes").itemForElement(e.srcElement)
        if(e.srcElement.checked==true) {
          if(this.topics) {
            this.push("topics", selected.$val)
          }
          else {
            this.topics = [selected.$val]
          }

        }
        else {
          var index = this.topics.indexOf(selected.$val)
          this.splice("topics",index,1);
        }
      },

      checkCollection: function(e) {
        var selected = document.getElementById("collectionCheckboxes").itemForElement(e.srcElement)
        if(e.srcElement.checked==true) {
          if(this.collections) {
            this.push("collections", selected.$val)
          }
          else {
            this.collections = [selected.$val]
          }
        }
        else {
          var index = this.collections.indexOf(selected.$val)
          this.splice("collections",index,1);
        }
      },

      checkrType: function(e) {
        var selected = document.getElementById("rTypeCheckboxes").itemForElement(e.srcElement)
        if(e.srcElement.checked==true) {
          if(this.rTypes) {
            this.push("rTypes", selected.$val)
          }
          else {
            this.rTypes = [selected.$val]
          }
        }
        else {
          var index = this.rTypes.indexOf(selected.$val)
          this.splice("rTypes",index,1);
        }
      },

      checkTag: function(e) {
        var selected = document.getElementById("tagCheckboxes").itemForElement(e.srcElement)
        if(e.srcElement.checked==true) {
          if(this.tags) {
            this.push("tags", selected.$val)
          }
          else {
            this.tags = [selected.$val]
          }
        }
        else {
          var index = this.tags.indexOf(selected.$val)
          this.splice("tags",index,1);
        }
      },

      fileupload: function(event) {
        event.preventDefault();
        //check resource name exists, give warning and remove files if not

        //create file upload task
        var file = event.detail.file;
        console.log(file)
        var ssdResourcesApp=firebase.app("SSD-Resources")
        console.log(ssdResourcesApp)
        var ref = firebase.storage(ssdResourcesApp).ref().child(this.resourceId+'/'+file.name)
        console.log(ref)
        var uploadTask=ref.put(file);
        uploadTask.on('state_changed',function(snapshot){
            var progressBars = document.querySelectorAll('paper-progress');
            console.log(progressBars);
            var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            var vaadinUploads=document.querySelector('vaadin-upload')
            console.log(vaadinUploads)
            var uploadsMeta=vaadinUploads.get('files');
            var index=_getCurrentIndex(file,uploadsMeta)
            console.log(index)
            progressBars[index].set('value',progress)
        }, function(error) {
          console.log(error)
          // Handle unsuccessful uploads
        }, function() {
          console.log('uploadTask',uploadTask)
          // //set progress bar to complete
          var vaadinUploads=document.querySelector('vaadin-upload')
          var uploadsMeta=vaadinUploads.get('files');
          console.log(uploadsMeta);
          console.log(vaadinUploads);
          var vaadinFiles=document.querySelectorAll('vaadin-upload-file')
          var index=_getCurrentIndex(file,uploadsMeta)
          vaadinFiles[index].set('file.complete',true);
          vaadinFiles[index].set('file.loaded',100);

          if(!document.querySelector("ssd-resource").uploadedFiles){
            document.querySelector("ssd-resource").uploadedFiles = []
          }
          // just pushing the new file item to the uploadedFiles array loses a bunch of the file metadata (I guess the perils of forcing a file object into a database array?)  So - terrible hack time:

          var fileItem = [];
          fileItem.name = vaadinUploads.files[index].name;
          fileItem.lastModified = vaadinUploads.files[index].lastModifiedDate;
          fileItem.size = vaadinUploads.files[index].size;
          console.log(fileItem);

          //set or create the file to edit (should always be create, as files need to be removed and re-uploaded instead of editing)
          //fileID = null so firebase-document object creates new item (I think)
          document.querySelector("ssd-resource").fileId = null;

          //add new fileItem
          document.querySelector("ssd-resource").set("editingFile",fileItem);

          console.log(document.querySelector("ssd-resource").uploadedFiles);


          });
        },

        statechanged: function(event) {
          console.log(event.detail.file);
        },






    })

  </script>
</dom-module>
