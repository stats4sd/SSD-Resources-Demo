<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-elements/iron-elements.html">

<link rel="import" href="SSD Components/ssd-resource-small.html">
<link rel="import" href="SSD Components/ssd-resource-full.html">
<link rel="import" href="SSD Components/ssd-resource-editor.html">
<link rel="import" href="SSD Components/ssd-search.html">
<link ref="import" href="../bower_components/paper-fab/index.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">


<dom-module id="ssd-resources">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        padding: 10px;
      }

      .resources-container {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        -ms-overflow-style: -ms-autohiding-scrollbar;
      }

      h1 {
        margin: 0
      }


      }
    </style>

    <!--  SETTING UP RESOURCES -->

    <!-- <paper-button raised on-tap='search'>
      <iron-icon icon="search"></iron-icon>
      Search
    </paper-button> -->
    <!-- <paper-button raised on-tap='addResource'>
      <iron-icon icon="add"></iron-icon>
      Add resource
    </paper-button> -->
    <div style='display:inline-flex'>
      <div style='width: 280px; height: 100%; background-color:white;margin-right:20px;flex: 1 1 auto;box-shadow: 5px 5px 5px #cccccc;position:relative;top:-20px' hidden$={{!veryWide}}>
        <!-- added position relative and top:-20px to push the sidebar up underneath the header. Then added empty div to push the h2 element back down to the correct position. -->
        <div style='height:20px;'></div>
        <h2 style='height:235px;line-height:235px;margin-top:0;'>Latest Resources</h2>
      </div>
    <div style="flex: 1 1 auto;">
      <div style='height: 25px;'></div>
      <div class='thin-title' hidden$={{veryWide}}>
        <h1>Latest Resources</h1>
      </div>
      <div class="resources-container" hidden$="[[liveMode]]">
        <template id="resourceList" is="dom-repeat" items="[[persistedNewestResources]]" as="resource" sort="_sortNewest">
          <ssd-resource-small resource='[[resource]]' on-tap='resourceTap'></ssd-resource-small>
        </template>
      </div>
      <div class="resources-container" hidden$="[[!liveMode]]">
        <template id="resourceList2" is="dom-repeat" items="[[resources]]" as="resource" sort="_sortNewest">
          <ssd-resource-small resource='[[resource]]' hidden$='[[!resource.name]]' on-tap='resourceTap'></ssd-resource-small>
        </template>
      </div>
    </div>
  </div>
    <ssd-resource-full id="fullResource" resource='[[selectedResource]]' opened='{{resourceOpened}}' persisted-topics="[[persistedTopics]]" persisted-r-types="[[persistedRTypes]]"
      persisted-tags="[[persistedTags]]" persisted-collections="[[persistedCollections]]" on-update="updateFired">
    </ssd-resource-full>


    <ssd-search id="search" filtered-resources="[[resources]]" all-resources="[[resources]]" persisted-topics="[[persistedTopics]]"
      persisted-r-types="[[persistedRTypes]]" persisted-tags="[[persistedTags]]" persisted-collections="[[persistedCollections]]">
    </ssd-search>


    <firebase-query id="query" app-name="SSD-Resources" path="/collections" data="{{allCollections}}"></firebase-query>
    <app-indexeddb-mirror key="persistedCollections" data="{{allCollections}}" persisted-data="{{persistedCollections}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/rTypes" data="{{allrTypes}}"></firebase-query>
    <app-indexeddb-mirror key="persistedRTypes" data="{{allrTypes}}" persisted-data="{{persistedRTypes}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/topics" data="{{allTopics}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTopics" data="{{allTopics}}" persisted-data="{{persistedTopics}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/events" data="{{allEvents}}"></firebase-query>
    <app-indexeddb-mirror key="persistedEvents" data="{{allEvents}}" persisted-data="{{persistedEvents}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/tags" data="{{alltags}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTags" data="{{alltags}}" persisted-data="{{persistedTags}}" session="keepAlways"></app-indexeddb-mirror>


    <!-- FIREBASE QUERY TO PULL IN RESOURCES FROM DB  -->
    <firebase-query id="query" app-name="SSD-Resources" path="/resources" data="{{resources}}"></firebase-query>
    <app-indexeddb-mirror key="persistedResources" data="{{resources}}" persisted-data="{{persistedResources}}"></app-indexeddb-mirror>

    <!-- FIREBASE QUERY TO PULL IN newest FROM DB  -->
    <firebase-query id="query" app-name="SSD-Resources" path="/resources" data="{{newestResources}}" limit-to-last="10"></firebase-query>
    <app-indexeddb-mirror key="persistedNewestResources" data="{{newestResources}}" persisted-data="{{persistedNewestResources}}"></app-indexeddb-mirror>

  </template>

  <script>
    Polymer({
      is: 'ssd-resources',

      properties: {
        resourceOpened: {
          type: Boolean,
          value: false,
          notify: true
        },
        topicActive: {
          type: Boolean,
          value: false
        },
        rTypeActive: {
          type: Boolean,
          value: false
        },
        tagActive: {
          type: Boolean,
          value: false
        },
        filter_topics: {
          type: Object,
          observer: 'filterChange',
          value: []
        },
        filter_rTypes: {
          type: Object,
          observer: 'filterChange',
          value: []
        },
        filter_tags: {
          type: Object,
          observer: 'filterChange',
          value: []
        },
        selectedResource: {
          type: Object,
          value: [],
          notify: true
        },
        editMode: {
          type: Boolean,
          value: false,
          notify: true,
        },
        liveMode:{
          type:Boolean,
          value:false
        }

      },
      resourcesChanged:function(res){
        console.log('res changed',res)
      },
      updateFired:function(){
        console.log('res updated')
        //this.$.resourceList2.render()
        this.liveMode=true
      },
      resourceTap: function (e) {
       this.$.fullResource.open(e.model.resource);
      },
      //responds to calls from add resource button and passes empty request to resource open
      addResource: function () {
        this.$.fullResource.open();
      },
      search: function () {
        this.$.search.open();
      },
      filterChange: function () {
        console.log('filters updated')
        var temp = this.persistedResources
        var filtersList = ['topics', 'rTypes', 'tags']
        this.activeFilters = {}
        //populate filter list with currently selected - should be moved out to only calculate on change
        for (let filter of filtersList) {
          var string = 'filter_' + filter
          if (this[string] != undefined && this[string] != '') {
            if (this[string] != "(all)") {
              this.activeFilters[filter] = this[string]
            }
          }
        }
        this.persistedResources = []
        this.persistedResources = temp
      },

      _sortNewest: function (a, b) {
        if (a.created > b.created) { return -1 }
        else  { return 1 }
      },

    });
  </script>
</dom-module>
