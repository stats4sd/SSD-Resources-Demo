<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="SSD Components/ssd-resource.html">
<link rel="import" href="SSD Components/ssd-resource-editor.html">
<link ref="import" href="../bower_components/paper-fab/index.html">

<dom-module id="ssd-resources">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }


    </style>

    <!--  SETTING UP RESOURCES -->
    <!--can add multi to listbox but will need to change default fire event-->
    <paper-dropdown-menu label="Topics" value="{{filter_topics}}" no-animations placeholder="(all)">
      <paper-listbox selected="0" class="dropdown-content">
        <paper-item>(all)</paper-item>
        <template is="dom-repeat" items="{{persistedTopics}}">
          <paper-item>{{item.$val}}</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
    <paper-dropdown-menu label="Resource Types" value="{{filter_rTypes}}" no-animations placeholder="(all)">
      <paper-listbox selected="0" class="dropdown-content">
        <paper-item>(all)</paper-item>
        <template is="dom-repeat" items="{{persistedrTypes}}">
          <paper-item>{{item.$val}}</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>
    <paper-dropdown-menu label="Tags" value="{{filter_tags}}" no-animations placeholder="(all)">
      <paper-listbox selected="0" class="dropdown-content">
        <paper-item>(all)</paper-item>
        <template is="dom-repeat" items="{{persistedTags}}">
          <paper-item>{{item.$val}}</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu>


    <h1>Resources</h1>
    <!--should work back in proper filter function-->
    <h3 $hidden="gotResources">Getting Resources</h3>
      <!-- <div class='col-lg-6 resourceCard'>
        <div class="card">
          <h3>{{resource.name}}</h3>
          <p><span class='bold'>Description: </span>{{resource.description}}</p>
          <ul>
            <li>
              <span class='bold'>Topics: </span>
              <template is="dom-repeat" items="{{resource.topics}}" as="topic">
                <span>{{topic}}; </span>
              </template>
            </li>
            <li>
              <span class='bold'>Resource Type(s): </span>
              <template is="dom-repeat" items="{{resource.rTypes}}" as="topic">
                <span>{{topic}}; </span>
              </template>
            </li>
            <li>
              <span class='bold'>Tags: </span>
              <template is="dom-repeat" items="{{resource.tags}}" as="topic">
                <span>{{topic}}; </span>
              </template>
          </div>
        </div> -->
      <!-- </div> -->



        <h1>Resource List</h1>
        <paper-button raised class='alert alert-info' toggles active="{{editMode}}" >
          <span hidden$="{{editMode}}">Enable Editing Mode</span>
          <span hidden$="{{!editMode}}">Disable Editing Mode</span>
        </paper-button>
        <div hidden$="{{!editMode}}" class='alert alert-info well well-sm'>
          <p class='alert alert-warning'>EDIT MODE ACTIVE. Click on any of the resource cards to edit that resource.</p>
          <paper-button raised on-tap="create" class='alert alert-success'>Add new resource</paper-button>
        </div>

        <div class$="[[checkedView(editMode)]]">
          <template id="resourceList" is="dom-repeat" items="[[persistedResources]]" as="resource" filter="filterResources">
            <ssd-resource
            view="[[editMode]]"
            id$="[[resource.$key]]"
            name="[[resource.name]]"
            description="[[resource.description]]"
            topics="[[resource.topics]]"
            r-types="[[resource.rTypes]]"
            tags="[[resource.tags]]"
            uploads="[[resource.uploads]]"
            on-tap='edit'
            ></ssd-resource>
          </template>
        </div>
        <!--<template id="selectedTopics" is="dom-repeat" items={{topicFilter}}>
          <h4>{{item}}</h4>
        </template>-->

    <firebase-query id="query" app-name="SSD-Resources" path="/collections" data="{{allCollections}}"></firebase-query>
    <app-indexeddb-mirror key="persistedCollections" data="{{allCollections}}" persisted-data="{{persistedCollections}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/rTypes" data="{{allrTypes}}"></firebase-query>
    <app-indexeddb-mirror key="persistedrTypes" data="{{allrTypes}}" persisted-data="{{persistedrTypes}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/topics" data="{{allTopics}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTopics" data="{{allTopics}}" persisted-data="{{persistedTopics}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/events" data="{{allEvents}}"></firebase-query>
    <app-indexeddb-mirror key="persistedEvents" data="{{allEvents}}" persisted-data="{{persistedEvents}}" session="keepAlways"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/tags" data="{{alltags}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTags" data="{{alltags}}" persisted-data="{{persistedTags}}" session="keepAlways"></app-indexeddb-mirror>


      <!-- FIREBASE QUERY TO PULL IN RESOURCES FROM DB  -->
      <firebase-query id="query" app-name="SSD-Resources" path="/resources" data="{{resources}}">
      </firebase-query>
      <app-indexeddb-mirror key="persistedResources" data="{{resources}}" persisted-data="{{persistedResources}}"></app-indexeddb-mirror>

    <!-- FIREBASE DOCUMENTS TO PULL IN Individual resource for editing  -->
    <firebase-document id="editingResource" app="SSD-Resources" app-name="SSD-Resources" path="{{editableResourceID}}" data="{{editableResource}}"><firebase-document>

    <ssd-resource-editor
      id="editor"
      resource-id="[[editableResourceID]]"
      resource="{{editableResource}}"
      persisted-topics="[[persistedTopics]]"
      persisted-r-types="[[persistedrTypes]]"
      persisted-tags="[[persistedTags]]"
      persisted-collections="[[persistedCollections]]"
      on-close="commitChange"
      >
    </ssd-resource-editor>

    <!-- ARRAY SELECTOR(S)  -->
    <!--<array-selector id='topicSelector' items="{{topics}}" selected="{{topicFilter}}" multi toggle></array-selector>
      <array-selector id='rTypeSelector' items="{{rTypes}}" selected="{{rTypeFilter}}" multi toggle></array-selector>
      <array-selector id='tagSelector' items="{{tags}}" selected="{{tagFilter}}" multi toggle></array-selector>-->



  </template>

  <script>
    Polymer({
      is: 'ssd-resources',

      properties: {
        resources: {
          type: Object,
          observer: 'dataChanged'
        },
        persistedResources: {
          type: Object,
          observer: 'dataChanged'
        },
        obj: Object,
        topics: Object,
        topicActive: {
          type: Boolean,
          value: false
        },
        rTypeActive: {
          type: Boolean,
          value: false
        },
        tagActive: {
          type: Boolean,
          value: false
        },
        filter_topics: {
          type: Object,
          observer: 'filterChange'
        },
        filter_rTypes: {
          type: Object,
          observer: 'filterChange'
        },
        filter_tags: {
          type: Object,
          observer: 'filterChange'
        },
      },


      filterChange: function () {
        console.log('filters updated')
        var temp = this.persistedResources
        var filtersList = ['topics', 'rTypes', 'tags']
        this.activeFilters = {}
        //populate filter list with currently selected - should be moved out to only calculate on change
        for (let filter of filtersList) {
          var string = 'filter_' + filter
          if (this[string] != undefined && this[string] != '') {
            if(this[string]!="(all)"){
              this.activeFilters[filter] = this[string]
            }

          }
        }
        this.persistedResources = []
        this.persistedResources = temp
      },

      filterResources: function (resource) {
        //***could run proper query on live, or even indexeddb query on local persistant//
        // var ssdResourcesApp=firebase.app("SSD-Resources")
        // var ref = ssdResourcesApp.database().ref('/resources')
        // ssdResourcesApp.database.Query

        console.log('total resources',this.persistedResources.length)
        return this._testFilters(resource, this.activeFilters)
        //remove getting resources message - not perfect as still getting more but don't know when complete

      },

      _testFilters: function (resource, activeFilters) {
        //test each filter. first time any filter fails return false
        for (let key in activeFilters) {
          var value = activeFilters[key]
          //return if doesn't have anything saved to filter field
          if (!resource.hasOwnProperty(key)) {
            return false
          }

          if (resource[key].indexOf(value) == -1) {
            return false
          }
        }
        return true
      },

      checkedView: function(editMode) {
        if(editMode) {
          return "alert alert-warning"
        }
        else {
          return ""
        }
      },

      dataChanged: function(newData, oldData) {
        this.$.resourceList.render();
        console.log(this.resources)

      },
      // _filterByKey: function (data, key, value) {

      // },

      // _toArray: function (obj) {
      //   return Object.keys(obj).map(function (key) {
      //     return {
      //       name: key,
      //       value: obj[key]
      //     };
      //   });
      // },

      // _filter: function (item) {
      //   console.log(this.topicFilter);

      //   //begin by assuming you WILL show the item
      //   var filter = true;
      //   console.log(filter)

      //   //if a topic filter is selected...
      //   // // check item against every chosen topic.
      //   // // // if that topic is NOT present, set filter to false and return. (no more checking needed)
      //   if (!this.topicFilter == []) {
      //     for (i = 0; i < this.topicFilter.length; i++) {
      //       if (item.value.topics == [] || item.value.topics == undefined) {
      //         filter = false;
      //         return;
      //       }
      //       else if (item.value.topics.indexOf(this.topicFilter[i]) == -1) {
      //         filter = false;
      //         return filter;
      //       }
      //     }
      //   }
      //   console.log(filter)

      //   //Do the same for resource type...
      //   if (!this.rTypeFilter == []) {
      //     for (i = 0; i < this.rTypeFilter.length; i++) {
      //       if (item.value.rTypes == [] || item.value.rTypes == undefined) {
      //         filter = false;
      //         return filter;
      //       }
      //       else if (item.value.rTypes.indexOf(this.rTypeFilter[i]) == -1) {
      //         filter = false;
      //         return filter;
      //       }
      //     }
      //   }
      //   //... and tags
      //   if (!this.tagFilter == []) {
      //     for (i = 0; i < this.tagFilter.length; i++) {
      //       if (item.value.tags == [] || item.value.tags == undefined) {
      //         filter = false;
      //         return filter;
      //       }
      //       else if (item.value.tags.indexOf(this.tagFilter[i]) == -1) {
      //         filter = false;
      //         return filter;
      //       }
      //     }
      //   }
      //   //If you reach this point, the item matches all selected filters, so just return.
      //   return filter;
      // },


      // //When selecting an item from the Topic Filters list
      // topicTapped: function (event) {
      //   //grab the correct filter text
      //   var res = event.target.innerText || event.target.textContent;
      //   //and use select() on the arraySelector to toggle the filter on or off
      //   this.$.topicSelector.select(res);
      //   console.log(this.topicFilter);
      //   //finally, tell the dom-repeat resource list to re-render (needed to trigger the _filter again)
      //   this.$.resourceList.render();
      // },

      // //When selecting an item from the rType Filters list
      // rTypeTapped: function (event) {
      //   //grab the correct filter text
      //   var res = event.target.innerText || event.target.textContent;
      //   //and use select() on the arraySelector to toggle the filter on or off
      //   this.$.rTypeSelector.select(res);
      //   console.log(this.rTypeFilter);
      //   //finally, tell the dom-repeat resource list to re-render (needed to trigger the _filter again)
      //   this.$.resourceList.render();
      // },

      // //When selecting an item from the tag Filters list
      // tagTapped: function (event) {
      //   //grab the correct filter text
      //   var res = event.target.innerText || event.target.textContent;
      //   //and use select() on the arraySelector to toggle the filter on or off
      //   this.$.tagSelector.select(res);
      //   console.log(this.tagFilter);
      //   //finally, tell the dom-repeat resource list to re-render (needed to trigger the _filter again)
      //   this.$.resourceList.render();
      // }

        //Next bits rely heavily on pasted code from notes-app...

        edit: function(event) {
          if(this.editMode) {
            var card = Polymer.dom(event).localTarget;
            console.log(card);
            console.log(card.id)
            console.log("tapped to edit");
            this.editableResourceID = "/resources/"+card.id;
            console.log(this.editableResourceID)
            this.$.editingResource.transactionsComplete.then(function() {
              console.log(this.editableResource)

              this.$.editor.open(card);
            }.bind(this));
          }

        },

        //function to create a new resource (called from new-resource button)
        create: function() {
          //if Edit mode is enabled
          if (this.editMode) {
            //set editable Note ID to null (so no resource is overwritten)
            this.editableResourceID = null;
            this.editableResource.name = "New Resource";
            console.log(this.editableResource);
            //open editor with null ID.
            //

            // if(this.$.query && this.$.query.refresh) {
            var commitNew;
            commitNew = this.save();

          //  if(this.$.query && this.$.query.refresh) {
              commitNew.then(function() {
                  console.log(this.editableResourceID)
                  this.editableResourceID = this.$.editingResource.path.slice(11,this.$.editingResource.path.length)
                  console.log(this.editableResourceID)

                  this.$.editor.open();
                  this.$.query.refresh();

              }.bind(this));
          //  }
            // }
          }
        },

        commitChange: function(event) {
          var changeCommits;

          switch(event.detail) {
            case 'save':
              changeCommits = this.save();
              break;
            case 'delete':
              changeCommits = this.delete();
              break;
            default:
              changeComits = Promise.resolve();
              break;
            }

            if (this.$.query && this.$.query.refresh) {
              changeCommits.then(function() {
                this.$.editingResource.reset();
                this.$.query.refresh();
              }.bind(this));
            }
          },

        save: function() {
          if (this.$.editingResource.isNew &&
              (this.editableResource.name ||
               this.editableResource.description ||
                this.editableResource.upload)) {

                  console.log("editableResourceID = " +this.editableResourceID);
                  console.log("editableResource = " +this.editableResource);

            return this.$.editingResource.save("/resources").then(function() {
              console.log(this.$.editingResource.data);
              console.log(this.$.editingResource.path);

              console.log("editableResourceID = " +this.editableResourceID);
              console.log("editableResource = " +this.editableResource);
              //this.$.editingResource.reset();
            }.bind(this));
          }
          return Promise.resolve();
        },
    });
  </script>
</dom-module>
