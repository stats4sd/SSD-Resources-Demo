<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./ssd-elements/resource-search-result.html">
<link rel="import" href="stats4sd-category-data.html">
<link rel="import" href="stats4sd-common-styles.html">

<dom-module id="stats4sd-list">

  <template>

    <style include="shared-styles">
      .grid {
        @apply --layout-horizontal;
        @apply --layout-wrap;
        @apply --layout-justified;
        margin: 0 10px 32px 10px;
        padding: 0;
        list-style: none;
      }

      .grid li {
        -webkit-flex: 1 1;
        flex: 1 1;
        -webkit-flex-basis: 33%;
        flex-basis: 33%;
        max-width: 33%;
      }

      .grid a {
        display: block;
        text-decoration: none;
      }
      h1{
        text-align: center;
        margin-bottom: 0
      }
      .counter{
        text-align: center;
        margin-bottom: 16px;
      }

      @media (max-width: 767px) {
        .hero-image {
          display: none;
        }

        .grid li {
          -webkit-flex-basis: 50%;
          flex-basis: 50%;
          max-width: 50%;
        }
      }
    </style>

    <!--
      app-route provides the name of the category.
    -->
    <app-route route="[[route]]" pattern="/:category" data="{{routeData}}"></app-route>

    <!--
      stats4sd-category-data provides the category data for a given category name.
    -->
    <stats4sd-category-data id="categoryData" slug="[[routeData.category]]" label="{{label}}" filtered-resources="{{filteredResources}}"
      resources="[[persistedResources]]"></stats4sd-category-data>

    <header>
      <!-- add s onto end of label when loaded, could put into calcuation to check if already s exists of simply try to avoid when creating types -->
      <h1>[[_getPluralizedQuantity(label,2)]]</h1>
      <div class="counter">[[resourcesRendered]] [[_getPluralizedQuantity('Resource',resourcesRendered)]]</div>

    </header>

    <ul class="flex wrap" hidden$="[[!failure]]">
      <dom-repeat id="resourcesList" items="[[filteredResources]]" as="resource" initial-count="4" filter="resourceFilter" rendered-item-count="{{resourcesRendered}}" sort="resourceSort">
        <template>
          <resource-search-result resource='[[resource]]'></resource-search-result>
        </template>
      </dom-repeat>
    </ul>

  </template>

  <script>
    class stats4sdList extends Polymer.Element {

      static get is() { return 'stats4sd-list'; }

      static get properties() {
        return {

          route: Object,

          routeData: Object,

          visible: {
            type: Boolean,
            value: false
          },

          offline: {
            type: Boolean,
            observer: '_offlineChanged'
          },

          categoryKey: {
            type: String,
            observer: '_categoryKeyChange',
          },
          filteredResources: {
            type: Array,
          },
        }
      }

      static get observers() {
        return []
      }

      connectedCallback() {
        super.connectedCallback();
        this.isAttached = true;
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this.isAttached = false;
      }
      resourceFilter(res){
        // don't show resources marked as deleted or draft
        if(res.deleted||res.draft){
          return false
        }
        else{return true}
      }
      resourceSort(a,b){
        return b.modified-a.modified
      }

      _failureCheck() {
        return this.filteredResources.length > 0
      }

      _categoryKeyChange(key) {
        console.log('cat key change',key)
        this.$.resourcesList.render()
      }

      _getPluralizedQuantity(label,quantity) {
        if(!label){return ''}
        if(!quantity){return label+'s'}
        if(quantity==1 || label.slice(-1)=='s'){
          return label
        }
        else{return label+'s'}
      }

      _tryReconnect() {
        this.$.categoryData.refresh();
      }

      _offlineChanged(offline) {
        if (!offline && this.isAttached) {
          this._tryReconnect();
        }
      }

    }

    customElements.define(stats4sdList.is, stats4sdList);
  </script>

</dom-module>