<!--See form docs at: https://elements.polymer-project.org/elements/iron-form-->

<!--import polymer html and shared styles-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-form/demo/simple-element.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">

<link rel="import" href="shared-styles.html">

<!--give id reference of page name-->
<dom-module id="ssd-add-resource">
  <template is="dom-bind">
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
      
      paper-material {
        display: inline-block;
        background: white;
        box-sizing: border-box;
        width: 100%;
        margin: 8px;
        padding: 16px;
        border-radius: 2px;
      }
      
      paper-progress {
        width: 100%
      }
    </style>

    <paper-material elevation="1">
      <form is="iron-form" method="get" action="/" id="basic">
        <paper-input name="title" label="Title" required auto-validate pattern="[a-zA-Z0-9 ']*" error-message="no special characters!"></paper-input>
        <paper-button raised onclick="collections.open()">Collections</paper-button>
      </form>
      <vaadin-upload id="ssdResourceUpload"></vaadin-upload>
      <br>
      <paper-button raised on-tap="_submit">Submit</paper-button>
      <paper-button raised onclick="_reset(event)">Reset</paper-button>
      <div class="output">

        <paper-dialog id="collections">
      <h2>Collections</h2>
      <paper-dialog-scrollable>
        <template is="dom-repeat" items="[[persistedCollections]]" as="collection">
          <paper-checkbox value="{{collection.$val}}" checked="{{checked[collection.$key]}}">{{collection.$val}}</paper-checkbox>
        </template>
        <!--<template is="dom-repeat" items="[[items]]" as="item">
          <p>{{item}}</p>
        </template>-->
      </paper-dialog-scrollable>
      <paper-button autofocus onclick="collections.close()">Close</paper-button>
    </paper-dialog>

    </paper-material>

    

    <firebase-query id="query" app-name="SSD-Resources" path="/collections" data="{{allCollections}}"></firebase-query>
    <app-indexeddb-mirror key="persistedCollections" data="{{allCollections}}" persisted-data="{{persistedCollections}}"></app-indexeddb-mirror>
    <firebase-query id="query" app-name="SSD-Resources" path="/rTypes" data="{{allrTypes}}"></firebase-query>
    <app-indexeddb-mirror key="persistedrTypes" data="{{allrTypes}}" persisted-data="{{persistedrTypes}}"></app-indexeddb-mirror>

    <script>
  // function _submit(event) {
  //   Polymer.dom(event).localTarget.parentElement.submit();
  //   console.log('submitted')
  // }
  function _reset(event) {
    var form = Polymer.dom(event).localTarget.parentElement
    form.reset();
    form.querySelector('.output').innerHTML = '';
  }

  //hack around vaadin upload to use firebase file put
  //can be improved on with full rewrite of vaadin-upload
  var upload1 = document.querySelector('vaadin-upload#ssdResourceUpload');
  upload1.addEventListener('upload-before', function(event) {
    event.preventDefault();
    if(!this.myfiles){this.myFiles=[]}
    // if(document.getElementById('fileList')){document.getElementById('fileList').remove();}    
    var file = event.detail.file;
    var index=this.myFiles.length
    this.myFiles.push(file)
    var ssdResourcesApp=firebase.app("SSD-Resources")
    var ref = firebase.storage(ssdResourcesApp).ref().child('uploads'+file.uploadTarget)
    var uploadTask=ref.put(file);
    uploadTask.on('state_changed',function(snapshot,i=index){
      var newIndex=i +this.myFiles.length-1
      var progressBars = document.querySelectorAll('paper-progress');
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      progressBars[newIndex].set('value',progress)
      switch (snapshot.state) {
        case firebase.storage.TaskState.PAUSED: // or 'paused'
          break;
        case firebase.storage.TaskState.RUNNING: // or 'running'
          break;
    }
  }.bind(this), function(error) {
    console.log(error)
    // Handle unsuccessful uploads
  }, function(success, i=index) {
    var newIndex=i +this.myFiles.length-1
    var vaadinFiles=document.querySelectorAll('vaadin-upload-file')
    vaadinFiles[newIndex].set('file.complete',true)
    var downloadURL = uploadTask.snapshot.downloadURL;
    }.bind(this));
    }.bind(this));

  
  </script>

  <script>
    this.checked={0:true,1:false}
  </script>
  </template>
  

  <script>
  
    Polymer({
      is: 'ssd-add-resource',
      properties:{
        items:{
          type:Object,
          observer:'itemChanged'
        },
        checked:{
          type:Object,
          observer:'checkChanged'
        }
      },
      checkChanged:function(){console.log(this.checked)},
      itemChanged:function(e){console.log('items changed',this.items)},
      _submit:function(){
        console.log('submitted')
      this.querySelector('.output').innerHTML = JSON.stringify(event.detail);}
    });
  </script>
  
</dom-module>