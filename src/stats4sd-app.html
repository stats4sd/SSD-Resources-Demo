<!-- Initial imports. These are declared here during development, and compiled to be more efficient during build -->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<!-- <link rel="import" href="./ssd-elements/resource-featured.html"> -->
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="stats4sd-app-layout.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="stats4sd-category-data.html">
<link rel="import" href="redux-mixin.html">
<!-- Since 'home' is the default route, eagerly load it. -->
<link rel="import" href="stats4sd-home.html">

<link rel="import" href="stats4sd-app-style.html">

<!-- The dom-module actually contains the element, it defines the tags another element can use to call it, e.g. <stats4sd-app> -->
<dom-module id="stats4sd-app">

  <!-- The "template" is the style and html part of the element. Below that are the properties and functions -->
  <template>
    <style include="stats4sd-app-style"></style>
    <!-- These are styles specific to this element. The 'include="shared-styles" means that the code in shared-styles.html is also used to render things in this element.' -->
    <style include="shared-styles">
       :host {
        max-width: 1080px;
        margin-left: auto;
        margin-right: auto;
        display: block;
        position: relative;
        background-color: gray;
        --app-primary-color: black;
        --app-secondary-color: #d2232a;
        background-color: var(--background-color, '#eeeeee');
        --app-accent-color: #172C50;
        --paper-button-ink-color: var(--app-accent-color);
        --paper-icon-button-ink-color: var(--app-accent-color);
        --paper-spinner-color: var(--app-accent-color);
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        color: var(--app-primary-color);
      }
    </style>

    <stats4sd-analytics key="{{analyticsKey}}"></stats4sd-analytics>
    <!--
      app-location and app-route elements provide the state of the URL for the app. 
      The app-location grabs the url and saves it to {{route}}. 
      The app-route then looks at the {{route}} and splits it into 2 pieces: the main part, and the "tail". The main part determines what page is displayed, and the tail is given to the page as input.

      The pattern="/:page" means that, for a url https://url/something, the "something" is saved to {{routeData.page}} (which is used to update the {{page}} and display the correct content).
      Anything after the page is called the 'tail', and saved to {{subroute}}.  So, for https://url/something/else, the "else" is saved to {{subroute}}. This is then passed to the various page elements within the iron-pages (e.g. stats4sd-home, stats4sd-list, etc) as that page's new {{route}}.
    -->
    <app-location route="{{route}}"></app-location>

    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>

    <!--
      iron-media-query element runs a media-style query. The result is put into the "query-matches" property
      In this case, if the width is <= 767px, {{smallScreen}} == true. This is used to change things about the display based on the screen size.
     -->
    <iron-media-query query="max-width: 767px" query-matches="{{smallScreen}}"></iron-media-query>

    <!-- This is the link to the firebase database. All firebase queries and documents throughout all pages refer to this app by its name. -->
    <firebase-app name="stats4sd-resources" api-key="{{firebaseConfig.apiKey}}" storage-bucket="{{firebaseConfig.storageBucket}}" auth-domain="{{firebaseConfig.authDomain}}" database-url="{{firebaseConfig.databaseURL}}">
    </firebase-app>

    <!--
      Query the database to return a set of all resources and a set of all tags.
      Then, use the app-indexeddb-mirror elements to put it all into local storage bound to the {{persisted###}} properties.
     -->
    <firebase-query id="resQuery" app-name="stats4sd-resources" path="/resources" data="{{resources}}"></firebase-query>
    <app-indexeddb-mirror key="persistedResources" data="{{resources}}" session="keepAlways" persisted-data="{{persistedResources}}"></app-indexeddb-mirror>
    <firebase-query id="tagsQuery" app-name="stats4sd-resources" path="/tags" data="{{tags}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTags" data="{{tags}}" session="keepAlways" persisted-data="{{persistedTags}}"></app-indexeddb-mirror>

     <!-- This is the main layout, it contains the sidebars, headers, lists of pages etc. -->
     <stats4sd-app-layout></stats4sd-app-layout>

<!-- Login box (starts hidden. This is opened when the user clicks on the sign-in button in the header. -->
      <paper-dialog id="login" modal>
        <paper-dialog-scrollable>
          <!-- We use a slightly customised version of the firebase-login element.
          This provides us with the {{user}} and {{signedIn}} properties, so we can hide or show things that require authentication -->
          <login-element id="stats4sdLogin" app-name="stats4sd-resources" user="{{user}}" signed-in="{{signedIn}}">
          </login-element>
        </paper-dialog-scrollable>
      </paper-dialog>

  </template>

  <script type="text/javascript" src="./environment/environment.js"></script>
  <script type="text/javascript" src="./environment/setConfig.js"></script>

  <!-- Properties and functions attached to the main app element -->
  <script>
    // performance logging
    window.performance && performance.mark && performance.mark('stats4sd-app - before register');

    // Define the overall class (defines properties, functions etc that will be available to the element)
    // This first of all extends the standard polymer (extends...(Polymer.Element)) element imported in every custom element, 
    // but also has a second extension 'ReduxMixin' which provides access to the redux store and additional behaviours defined
    // in the redux-mixin.html file

    // of note is an additional 'statePath' subproperty (not used here but see stats4sd-app-layout) which provides an automatic
    // binding to the value of a given path in the global data store. Additionally we have an optional 'actions' decorator
    // which is used to define specific functions called via this.dispatch(function,value). These update the global data store
    class Stats4sdApp extends ReduxMixin(Polymer.Element){

      static get is() { return 'stats4sd-app'; }

      static get properties() {
        return {
          page: {
            type: String,
            observer: '_pageChanged'
          },
          signedIn: {
            type: Boolean,
            observer: '_signedInChange'
          },
          collectionAddMode: {
            type: Boolean,
            value: false
          },
          resourcesjson: {
            type: Object,
            value: { test: 123 }
          },
          smallScreen: {
            type: Boolean,
            // observe changes to small screen value given by media query, and dispatch to the global store
            observer:function(newVal){
              return this.dispatch('updateSmallscreen',newVal)
            }
          },
          firebaseConfig:{
            type:Object
          },
          analyticsKey:{
            type:String
          },
        }
      }
      
      // actions update the global data store of particular variables (defined in the redux-mixin html doc)
      // they are called from this.dispatch(function,value). You can inspect these through the 'Redux dev tools' browser plugin
      static get actions(){
        return{
          updateSmallscreen(isSmall){
            return{
              type:'UPDATE_SMALLSCREEN',
              payload:isSmall
            }
          },
          updatePage(page){
            return{
              type:'UPDATE_PAGE',
              payload:page
            }
          }
          
        }
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ]
        
        // note, could use persistedFeatured.length to simply track number of items
      }

      constructor() {
        super();
        // set firebase config from window object (populated in earlier script calls)
        this.firebaseConfig = window.firebaseConfig
        this.analyticsKey = window.analyticsKey
        // performance (?)
        window.performance && performance.mark && performance.mark('stats4sd-app.created');
      }

      ready() {
        super.ready();
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
        // listen for custom events
        //// This is one of the main ways of communicating between elements.
        //// Child elemenets send custom events, and these event listeners hear them, take whatever data is passed up (e) and passes the 'e' to the listed function.
        ///
        /////resource-change sent from 'resource-search-result' element.
        // e = specific resource object and url to that resource.
        this.addEventListener('resource-change', (e) => this._resourceChange(e));

        // this event is never sent
        this.addEventListener('show-invalid-url-warning', (e) => this._onFallbackSelectionTriggered(e));

        //resource-saved sent from 'stats4sd-resource' element. 
        // e = the resource object that has just been saved to the database.
        this.addEventListener('resource-saved', (e) => this._resourceSaved(e));

        // collection-resources-add sent from 'stats4sd-collection' element.
        // e = the collection being edited
        this.addEventListener('collection-resources-add', (e) => this._collectionResourcesAdd(e));

        // search sent from 'stats4sd-search' element.
        // e = the search text and any active filters.
        this.addEventListener('search', (e) => this._search(e));

        // listen for online/offline
        Polymer.RenderStatus.afterNextRender(this, () => {
          // window.addEventListener('online', (e) => this._notifyNetworkStatus(e));
          // window.addEventListener('offline', (e) => this._notifyNetworkStatus(e));
        });
      }

      // *Observer Function** for {{routeData.page}}
      _routePageChanged(page) {
        //Degm- If page equals 'list', set scroll to top of page
        if (this.page === 'list') {
          this._listScrollTop = window.pageYOffset;
        }
        //set {{page}} to {{routeData.page}} - or 'home' as a default.
        this.page = page || 'home';
      }

      // **Observer Function** for {{page}}
      _pageChanged(page, oldPage) {
        // tell global store of new page
        this.dispatch('updatePage',page)
        this.lastPage = oldPage
        window.scrollTo(0, 0);
        //Assuming a {{page}} value exists:
        if (page != null) {
          // home route is eagerly loaded
          if (page == 'home') {
            this._pageLoaded(Boolean(oldPage));
            // other routes are lazy loaded
          } else {
            // When a load failed, it triggered a 404 which means we need to
            // eagerly load the 404 page definition
            let cb = this._pageLoaded.bind(this, Boolean(oldPage));
            Polymer.importHref(
              this.resolveUrl('stats4sd-' + page + '.html'),
              cb, cb, true);
          }
        }
      }

      //called during page loads
      _pageLoaded(shouldResetLayout) {
        this._ensureLazyLoaded();
        if (shouldResetLayout) {
          // The size of the header depends on the page (e.g. on some pages the tabs
          // do not appear), so reset the header's layout only when switching pages.
          // Polymer.Async.timeOut.run(() => {
          //   this.$.header.resetLayout();
          // }, 1);
        }
      }

      // **Event Function** 
      // Called when someone searches on the search page. 
      _search(e) {
        //All this does is pass the search data to the categoryData element. That element actually runs the search function.
        this.$.categoryData.search(e.detail)
      }

      //Function bound to the "back" button in the top-left. Uses the built-in 'back' function in the browser.
      goBack() {
        // go back in nav stack whilst browsing, if navigated direct and now history just go home
        if (this.lastPage) {
          window.history.back()
        }
        else {
          this.set('route.path', '/')
        }

      }

      //Function bound to the home button in the top-left. Sends the user home by setting the {{route.path}} property.
      //Degm- currently not in use
      goHome() {
        this.set('route.path', '/')
      }

      // **Event Function**
      // Receives info about a specific resource (e.g. resource clicked on by user).
      // Sets the current resource and the route.path so the user is directed to that resource.
      _resourceChange(e) {
        this.set('resource', e.detail.resource)
        console.log('resource', this.resource)
        this.set('route.path', e.detail.url)
      }

      // **Event Function**
      // Receives info about a specific resource when it is saved to the database
      // Sets the {{route.path}} to the saved resource, so it's automatically updated in current session.
      _resourceSaved(e) {
        // display toast and go back page after resource edit
        console.log('resource saved', e)
        this._showMessage('Resource Saved :-)')
        // this.set('route.path', '/resource/' + e.detail.resource.slug)
        window.history.back();
      }

      // Function used in various contexts to show a message via a 'toast' Element appearing. 
      // Useful for giving user feedback after saving, updating, deleting etc.
      _showMessage(message){
        console.log('showing message',message)
        this.toastMessage=message;
        this.$.toastMessage.open()
      }

      // Function used to define whether many elements are hidden or not.
      // Compares the active path with a _ seperated list of paths. If there is a match, return true (and hide the element)
      _hideOnPaths(activePath, pathsString) {
        // uses _ to seperate paths to hide on
        let paths = pathsString.split('_')
        // state whether to hide or show when active page matches test page
        for (let path of paths) {
          // identify wildcard, if yes allow fuzzy match
          if (path.indexOf('*') > -1) {
            path = path.slice(0, -1)
            if (activePath.indexOf(path) > -1) {
              return true
            }
          }
          else {
            if (activePath == path) {
              return true
            }
          }
        }
        return false
      }

      // Function bound to the "Edit Collection" button in the footer.
      // Degm- not currently in use (button commented out in favour of "manage collections" page).
      _editCollection() { this.$.collectionPage._editCollection(); }

      // Function bound to the "Add collection" button in the footer.
      // Triggers the _addCollection() function within the 'collectionPage' element
      _addCollection() { this.$.collectionPage._addCollection(); }

      // **Event Function** 
      // When clicking 'add resources' to a collection, this event is triggered.
      _collectionResourcesAdd() {
        console.log('adding resources to collection', this.activeCollection);
        //set the "collectionAddMode" boolean to true. This presents the "add" button next to resources in the search view, so they can be added to the collection currently active. 
        this.collectionAddMode = true
        //Automatically take the user to the search page so they can start adding resources without delay!
        this.set('route.path', '/search')
      }

      // Function bound to the "Save collection" button in the footer.
      // Triggers the saveCollection() function in the 'collectionPage' element.
      _saveCollection() { this.$.collectionPage.saveCollection() }

      // Function to determine whether the "edit resource" button should display within the footer.
      _hideResourceEdit(path) {
        //show on /resource/* but not on /resource/[slug]/edit
        if (path.indexOf('/resource/') > -1 && path.split('/').indexOf('edit') == -1) {
          return false
        }
        return true
      }

      // Function to determine whether the "save resource" button should display within the footer.
      _hideResourceSave(path) {
        //only show on /resource/[slug]/edit
        let split = path.split('/')
        if (split.length > 3 && split[3] == 'edit') {
          return false
        }
        return true
      }

      // Function to determine whether the home button should be shown.
      // Degm- currently not used?
      _hideHomeButton(path) {
        if (path == "/") {
          return false
        }
        if (path.indexOf('/list/') > -1) { return false }
        else {
          return true
        }
      }

      // Function bound to the "save resource" button in the footer.
      // Triggers the _saveResource() function from the resource Page.
      _saveResource() { this.$.resourcePage._saveResource() }

      // Function bound to the "edit resource" button in the footer.
      // Sends the user to the "/edit" screen for the currently displaying resource (by setting the {{route.path}});
      _editResource() {
        this.set('route.path', this.route.path + '/edit')
      }

      // Function that calls the _hideOnPaths() function, but then returns the opposite response.
      // (Appropriately named...)
      _showOnPaths(activePath, pathsString) {
        let hide = this._hideOnPaths(activePath, pathsString)
        return !hide
      }

      // Function involved in the loading of pages / elements.
      // (Degm- I have no idea what this does, but it works!)
      _ensureLazyLoaded() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          Polymer.RenderStatus.afterNextRender(this, () => {
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js', { scope: '/' });
              }
              // this._notifyNetworkStatus();
              this.loadComplete = true;
            });
          });
        }
      }

      //Functions to show or hide the cookie policy.
      // The _showCookiePolicy is bound to the 'cookie policy' text in the footer.
      // The _hideCookiePolicy is bound to the 'got it' text in the cookie toast element.
      _showCookiePolicy() { this.$.cookiePolicy.open() }
      _hideCookiePolicy() { this.$.cookiePolicy.close() }

      // _notifyNetworkStatus() {
      //   let oldOffline = this.offline;
      //   this.offline = !navigator.onLine;
      //   // Show the snackbar if the user is offline when starting a new session
      //   // or if the network status changed.
      //   if (this.offline || (!this.offline && oldOffline === true)) {
      //     if (!this._networkSnackbar) {
      //       this._networkSnackbar = document.createElement('stats4sd-snackbar');
      //       this.root.appendChild(this._networkSnackbar);
      //     }
      //     this._networkSnackbar.innerHTML = this.offline ?
      //       'You are offline' : 'You are online';
      //     this._networkSnackbar.open();
      //   }
      // }


      // Function bound to the 'sign-in' button.
      // Opens the login dialog. 
      _signInOpen() {
        this.$.login.open()
      }

      // Function bound to the sign-out button. 
      // Triggers the signOut() function in the custom 'login-element' element.
      _signOut() {
        this.$.stats4sdLogin.signOut();
        this.signedIn = false;
      }

      // **Observer Function** for {{signedIn}}
      // When the user signedIn status changes, ensure that the login dialog is closed.
      _signedInChange() {
        this.$.login.close()
      }


      // ************deprecated functions?? - to review ***************

      // Elements in the app can notify section changes.
      // Response by a11y announcing the section and syncronizing the category.
      _onChangeSection(event) {
        let detail = event.detail;

        // Scroll to the top of the page when navigating to a non-list page. For list view,
        // scroll to the last saved position only if the category has not changed.
        let scrollTop = 0;
        if (this.page === 'list') {
          if (this.categoryName === detail.category) {
            scrollTop = this._listScrollTop;
          } else {
            // Reset the list view scrollTop if the category changed.
            this._listScrollTop = 0;
          }
        }
        // Use `Polymer.AppLayout.scroll` with `behavior: 'silent'` to disable header scroll
        // effects during the scroll.
        Polymer.AppLayout.scroll({ top: scrollTop, behavior: 'silent' });

        this.categoryName = detail.category || '';

        // Announce the page's title
        if (detail.title) {
          document.title = detail.title + ' - stats4sd';
          this._announce(detail.title + ', loaded');
        }
      }


      // This is for performance logging only.
      _domChange(e) {
        if (window.performance && performance.mark && !this.__loggedDomChange) {
          let target = e.composedPath()[0];
          let host = target.getRootNode().host;
          if (host && host.localName.match(this.page)) {
            this.__loggedDomChange = true;
            performance.mark(host.localName + '.domChange');
          }
        }
      }

      // Function not in use
      // Sends the user to the 404 (not found) page.
      _onFallbackSelectionTriggered() {
        this.page = '404';
      }

    }


    /*  Each polymer element requires this 'define()' function.
        the first variable calls the '.is' property on the class, which is defined above:
            static get is() { return 'stats4sd-app'; }
        This just returns the same id as the dom module and hence component tag, <stats4sd-app>
        
        The second variable returns back the entire class that has been defined in this script (all functions, logic etc)
        which is made available to the component
    */
    customElements.define(Stats4sdApp.is, Stats4sdApp);
  </script>

</dom-module>