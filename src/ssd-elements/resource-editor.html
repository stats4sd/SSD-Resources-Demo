<!-- <link rel="import" href="../polymer/polymer-element.html"> -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="resource-editor">
  <template>
    <style>
       :host {
        display: block;
        padding: 10px;
      }
    </style>

    <!-- Firebase binding for live tag data -->
    <firebase-document path="/tags" data="{{liveTags}}" app-name="SSD-Resources"></firebase-document>

    <!-- Title and Description -->
    <paper-input id="resourceName" value="{{resource.name}}" name="title" label="Title of Resource" required></paper-input>
    <span class="url">[[origin]]/[[slug]]</span>
    <p>
      <paper-textarea id="resourceDescription" value="{{resource.description}}" name="description" label="Brief Description" required
        always-float-label></paper-textarea>
    </p>

    <!-- *** Need save function to track tags saved, possibly linked to combo change event to populate resource tags -->

    <!-- Tags -->
    <vaadin-combo-box label="Keywords" id="KeywordTypeCombo" items="[[_computeItems(liveTags,'Keywords')]]" item-value-path="key"
      on-change="_keywordChange" allow-custom-value on-filter-changed="_keywordFilterChanged">
    </vaadin-combo-box>
    <div hidden$="[[!newTag]]" on-tap="addTag">
      <div hidden$="[[!focused.Resource-Type]]">Press enter to add tag: [[newTag.label]]</div>
    </div>

    <vaadin-combo-box label="Resource Type" id="ResourceTypeCombo" items="[[_computeItems(liveTags,'Resource-Types')]]" item-value-path="key"
      on-change="_resourceTypeChange">
    </vaadin-combo-box>



    <!-- **************************** possibly manage collections elsewhere? ************************ -->

    <!-- <vaadin-combo-box label="Collections" id="Collection-TypeCombo" items="[[_computeItems(liveTags,'Collections')]]" item-value-path="key"
    allow-custom-value>
  </vaadin-combo-box> -->


    <!-- Published Checkbox (include method to publish other resources also) -->
    Published?


    <!-- 
    <vaadin-combo-box label="Resource Types" id="Resource-TypeCombo" items="[[_filterTags(persistedTags,'Resource-Type')]]" selected-item="{{tags.Resource-Type}}"
      filtered-items="{{filteredResource-Type}}" on-change="_comboChange" on-filter-changed="_filterChanged" focused="{{focused.Resource-Type}}"
      item-value-path="$key" item-value-path="label" allow-custom-value>
    </vaadin-combo-box>
    <div hidden$="[[!newTag]]" on-tap="addTag">
      <div hidden$="[[!focused.Resource-Type]]">Press enter to add tag: [[newTag.label]]</div>
    </div>
    <template is="dom-repeat" as="tag" items="[[_tagsToArray(resource.tags,'Resource-Type')]]" observe="tags resource.tags">
      <paper-button class="tag-button">{{tag.label}}
        <iron-icon icon="close" on-tap="removeTag"></iron-icon>
      </paper-button>
    </template>

    <vaadin-combo-box label="Collections" id="CollectionCombo" items="[[_filterTags(persistedTags,'Collection')]]" selected-item="{{tags.Collection}}"
      filtered-items="{{filteredCollections}}" on-change="_comboChange" on-filter-changed="_filterChanged" focused="{{focused.Collection}}"
      item-value-path="$key" item-value-path="label" allow-custom-value>
    </vaadin-combo-box>
    <div hidden$="[[!newTag]]" on-tap="addTag">
      <div hidden$="[[!focused.Collection]]">Press enter to add tag: [[newTag.label]]</div>
    </div>
    <template is="dom-repeat" as="tag" items="[[_tagsToArray(resource.tags,'Collection')]]" observe="tags resource.tags">
      <paper-button class="tag-button">{{tag.label}}
        <iron-icon icon="close" on-tap="removeTag"></iron-icon>
      </paper-button>
    </template>
     -->

    <!--live tag editor-->
    <!-- <firebase-document id="currentTag" app-name="SSD-Resources" data="{{currentTag}}" path="/tags/"></firebase-document>
    <firebase-document id="allTags" app-name="SSD-Resources" data="{{allTags}}" path="/tags"></firebase-document> -->

    <!-- 
    <h4>External Links</h4>
    <template id="externalLinks" is="dom-repeat" items="[[resource.externalLinks]]" as="link">
      <div class='flex-container'>
        <a href="{{link.url}}" target="_blank"><span>[[link.url]]</span></a>
        <paper-icon-button suffix on-tap="editLink" class="green" icon="mode-edit" alt="edit" title="edit">
        </paper-icon-button>
        <paper-icon-button on-tap="removeLink" class="red" icon="clear" alt="clear" title="clear">
        </paper-icon-button>
      </div>
    </template>

    <paper-input label="add any external links here" no-label-float value="{{resource.tempLinkUrl}}">
      <iron-icon icon="language" prefix></iron-icon>
      <paper-icon-button suffix on-tap="addLink" class="green" icon="add" alt="add" title="add" hidden$="{{link.saved}}">
      </paper-icon-button>
    </paper-input>

    <h4>Uploaded Files</h4>
    <vaadin-upload id="ssdResourceUpload" on-upload-before="fileupload" files="[[resource.uploadedFiles]]"></vaadin-upload>
    <iron-icon slot="drop-label-icon" icon="description"></iron-icon>
    <span slot="drop-label">Drop your favourite Novels here (PDF files only)</span>
    <div class="delete" on-tap="delete">
      <paper-icon-button icon="delete" class="delete-button"></paper-icon-button>
      <span>Delete Resource</span>
    </div>

    <h4>Feature Image</h4>
    <div class='flex-container'>
      <iron-selector>
        <template is="dom-repeat" as="tag" items="[[_tagsToArray(resource.tags,'Resource-Type')]]" observe="tags resource.tags">
          <div on-tap="setFeatureImage" class="feature-image">
            <img src="/images/resourceTypes/{{tag.slug}}.jpg">
            <div class="image-label">{{tag.label}}</div>
          </div>
        </template>
      </iron-selector>
    </div> -->


  </template>

  <script>
    /**
     * `resource-editor`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ResourceEditor extends Polymer.Element {
      static get is() { return 'resource-editor'; }
      static get properties() {
        return {
          slug: {
            type: String,
            computed: '_toSlug(resource.name)'
          },
          origin: {
            type: String,
            value: function () { return window.origin + '/resource' }
          },
        };
      }
      _toSlug(name) {
        if (!name) {
          //new resource
          this.resource.slug = ""
          return ""
        }
        else {
          //could definitely be combined into one expression but I suck at regex :( 
          //make lower case, replace all spaces with '-' and remove special
          var slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^0-9a-z-]/g, "");
          this.resource.slug = slug
          return slug
        }
      }
      _computeItems(tags, key) {
        // take liveTags, select subset and put into correct format (un-nest json)
        let items = tags[key]
        let temp = []
        for (let key in items) {
          let t = items[key]
          t.key = key
          temp.push(t)
        }
        return temp
      }
      _keywordFilterChanged(e) {
        // Refer to prior versions if wanting to make more general filter (e.g. same for keywords as well as collections on same page)
        var filterText = e.detail.value.toLowerCase()
        var items = this.$.KeywordTypeCombo.items
        console.log('items', items)
        if (!items) { items = [] }
        var filtered = items.filter(function (el) {
          var label = el.label.toLowerCase()
          return label.indexOf(filterText) !== -1;
        })
        if (filtered.length == 0) {
          this.newTag = {
            label: filterText,
            type: this.currentFilter
          }
        }
        if (filterText == "") { this.newTag = false }
        if (filtered.length > 0) { this.newTag = false }
      }
    }

    window.customElements.define(ResourceEditor.is, ResourceEditor);
  </script>
</dom-module>