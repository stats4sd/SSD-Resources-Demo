<!--See form docs at: https://elements.polymer-project.org/elements/iron-form-->

<!--import polymer html and shared styles-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="shared-styles.html">

<!--give id reference of page name-->
<dom-module id="ssd-add-resource">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;

      }

      paper-material {
        display: inline-block;
        background: white;
        box-sizing: border-box;
        width: 100%;
        margin: 8px;
        padding: 16px;
        border-radius: 2px;
      }
      .yellow-button {
        text-transform: none;
        color: #eeff41;
      }


      paper-progress {
        width: 100%
      }
      paper-checkbox{
        display:block
      }
      paper-dialog{
        margin:0;
        height:300px;
      }
    </style>
    <style is="custom-style">
      paper-tabs{
        --paper-tabs-selection-bar-color:var(--paper-green-700);
        --paper-tabs:{
          padding-bottom:10px
        }
      }
      vaadin-upload{
        --vaadin-upload-file-meta:{
          padding-left:16px
        }
      }

    </style>

    <paper-material elevation="1">

      <form is="iron-form" method="get" action="/" id="basic">
        <paper-input id="resourceName" value="{{resource.name}}" name="title" label="Title of Resource" required auto-validate pattern="[a-zA-Z0-9 ']*" error-message="no special characters!"></paper-input>
        <paper-textarea id="resourceDescription" value="{{resource.description}}" name="description" label="Brief Description" required></paper-textarea>
        <br>
        <paper-tabs selected="{{tabSelected}}">
          <paper-tab>Topics</paper-tab>
          <paper-tab>Collections</paper-tab>
          <paper-tab>Type</paper-tab>
          <paper-tab>Tags</paper-tab>
        </paper-tabs>
        <br>
        <iron-pages selected="{{tabSelected}}">
          <div><template is="dom-repeat" id="topicCheckboxes" items="[[persistedTopics]]" as="topic">
            <paper-checkbox value="topics_-_[[topic.$val]]">{{topic.$val}}</paper-checkbox>
          </template></div>
          <div><template is="dom-repeat" id="collectionCheckboxes" items="[[persistedCollections]]" as="collection">
            <paper-checkbox value="collections_-_[[collection.$val]]">{{collection.$val}}</paper-checkbox>
          </template></div>
          <div><template is="dom-repeat" id="rTypeCheckboxes" items="[[persistedrTypes]]" as="rType">
            <paper-checkbox value="rTypes_-_[[rType.$val]]">{{rType.$val}}</paper-checkbox>
          </template></div>
          <div><template is="dom-repeat" id="tagCheckboxes" items="[[persistedtags]]" as="tag">
            <paper-checkbox value="tags_-_[[tag.$val]]">{{tag.$val}}</paper-checkbox>
          </template></div>
        </iron-pages>
        <br><br>
        <p>Pin to upcoming events?</p>
        <paper-checkbox value="events_-_RM Workshop Kenya">RM Workshop Kenya</paper-checkbox>
      </form>
      <!--error message-->
      <paper-toast id="nameWarning" duration="0" text="Give the resource title before uploading files (manually remove pending downloads)">
      <paper-button onclick="nameWarning.toggle()" class="yellow-button">OK!</paper-button>
      </paper-toast>
      <vaadin-upload id="ssdResourceUpload" files="{{uploadedFiles}}"></vaadin-upload>

      <br>
      <paper-button raised on-tap="_submit" >Submit</paper-button>
      <div id='alertNote' class="output"></div>

    </paper-material>



    <firebase-query id="query" app-name="SSD-Resources" path="/collections" data="{{allCollections}}"></firebase-query>
    <app-indexeddb-mirror key="persistedCollections" data="{{allCollections}}" persisted-data="{{persistedCollections}}"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/rTypes" data="{{allrTypes}}"></firebase-query>
    <app-indexeddb-mirror key="persistedrTypes" data="{{allrTypes}}" persisted-data="{{persistedrTypes}}"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/topics" data="{{allTopics}}"></firebase-query>
    <app-indexeddb-mirror key="persistedTopics" data="{{allTopics}}" persisted-data="{{persistedTopics}}"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/events" data="{{allEvents}}"></firebase-query>
    <app-indexeddb-mirror key="persistedEvents" data="{{allEvents}}" persisted-data="{{persistedEvents}}"></app-indexeddb-mirror>

    <firebase-query id="query" app-name="SSD-Resources" path="/tags" data="{{alltags}}"></firebase-query>
    <app-indexeddb-mirror key="persistedtags" data="{{alltags}}" persisted-data="{{persistedtags}}"></app-indexeddb-mirror>


    <script>
    //fit toast to container
      nameWarning.fitInto = ssdResourceUpload;
    </script>

    <script>
  // function _submit(event) {
  //   Polymer.dom(event).localTarget.parentElement.submit();
  //   console.log('submitted')
  // }

  // hack around vaadin upload to use firebase file put
  // can be improved on with full rewrite of vaadin-upload
  var upload1 = document.querySelector('vaadin-upload#ssdResourceUpload');
  upload1.addEventListener('upload-before', function(event) {
    event.preventDefault();
    //check resource name exists, give warning and remove files if not
    var resourceName=document.querySelector('paper-input#resourceName').get('value')
    if(resourceName==undefined || resourceName==""){
      var vaadinUploads=document.querySelector('vaadin-upload')
      vaadinUploads.set('files',[])
      document.querySelector('paper-toast#nameWarning').open()
      return
      }
    //create file upload task
    var file = event.detail.file;
    var ssdResourcesApp=firebase.app("SSD-Resources")
    var ref = firebase.storage(ssdResourcesApp).ref().child('resources/'+resourceName+'/'+file.name)
    var uploadTask=ref.put(file);
    //add watch features
    uploadTask.on('state_changed',function(snapshot){
      var progressBars = document.querySelectorAll('paper-progress');
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      var vaadinUploads=document.querySelector('vaadin-upload')
      var uploadsMeta=vaadinUploads.get('files');
      var index=_getCurrentIndex(file,uploadsMeta)
      progressBars[index].set('value',progress)
      // switch (snapshot.state) {
      //   case firebase.storage.TaskState.PAUSED: // or 'paused'
      //     break;
      //   case firebase.storage.TaskState.RUNNING: // or 'running'
      //     break;
    // }
  }, function(error) {
    console.log(error)
    // Handle unsuccessful uploads
  }, function() {
    console.log('uploadTask',uploadTask)
    // //set progress bar to complete
    var vaadinUploads=document.querySelector('vaadin-upload')
    var uploadsMeta=vaadinUploads.get('files');
    var vaadinFiles=document.querySelectorAll('vaadin-upload-file')
    var index=_getCurrentIndex(file,uploadsMeta)
    vaadinFiles[index].set('file.complete',true);
    vaadinFiles[index].set('file.loaded',100);
    //append download url to file detail - still need to ensure correct for multiple
    var downloadURL = uploadTask.snapshot.downloadURL;
    vaadinFiles[index].set('file.downloadURL',downloadURL);
    console.log('uploads meta',uploadsMeta)
    });
    });

    function _getCurrentIndex(thisFile,fileList){
      var index=-1
      for (var i=0;i<fileList.length;i++){
        var name=fileList[i].name
        if(thisFile.name==name){
          index=i
        }
      }
      return(index)
    }
  </script>

  </template>

  <script>
    Polymer({
      is: 'ssd-add-resource',
      properties:{
        items:{
          type:Object,
          observer:'itemChanged'
        },
        resource:{
          type:Object,
          value:function(){return{}}
        },
        uploadedFiles:{
          type:Object,
          observer:'_uploadChange'

        },
        tabSelected:{
          value:0

        }
      },
      observers:['_resourceChange(resource.name)'],

      _resourceChange:function(newValue){

        },
      _uploadChange:function(){

        },

      checkChanged:function(){console.log(this.checked)},
      itemChanged:function(e){console.log('items changed',this.items)},
      _toggleTags:function(e) {
        var section = e.srcElement.getAttribute("value");
        console.log(section);
        this.$[section].toggle();
      },

      _updateCollection:function(e) {
        var name = e.srcElement.name;
        console.log(name);
        console.log(this.allTopics)
        if(name) {
          var value = e.srcElement.checked;
          console.log(value);
          var collectionName = e.srcElement.getAttribute("collection");
          console.log(collectionName);
          collectionName +="Add";
          if(value==true){
            this.set(collectionName+"."+name,value)
          }
          else {
            delete this[collectionName][name];
          }
        }
        console.log(collectionName)
        console.log(this.topicDisplay)
        console.log(this[collectionName])
      },

      _submit:function(){
        if(basic.validate()==false){
          this.$.alertNote.innerHTML = "<div class='alert alert-danger' role='alert'>Please check the form above for errors, and then try submitting again</div>";
          return
        }
        else {
          this.$.alertNote.innerHTML = "";


          //should have better data binding throughout to make easier to reload and edit
          //maybe also work so can use serialize()
          //initiate res
          var res={
            id:'test',
            name:'',
            description:'',
            collections:[],
            uploads:[],
            topics:[],
            rTypes:[],
            tags:[],
            events:[]

          }
          //get checkbox values and assign to fields
          var checkboxes=document.querySelectorAll('paper-checkbox');
          for(var i=0;i<checkboxes.length;i++){
            if(checkboxes[i].get('checked')==true){
              var meta=checkboxes[i].get('value').split('_-_')
              var field=meta[0]
              var val = meta[1]
              res[field].push(val)
              }
          }
          //set rest of form data
          res.name=document.querySelector('paper-input#resourceName').get('value')
          res.description=document.querySelector('paper-textarea#resourceDescription').get('value')
          res.uploads=document.querySelector('vaadin-upload#ssdResourceUpload').get('files')
          res.id= res.name.replace(/\s/g, "-");
          console.log('res',res)
          //upload to firebase
          var ssdResourcesApp=firebase.app("SSD-Resources")
          ssdResourcesApp.database().ref('resources/'+res.id).set({
            id:res.id,
            name:res.name,
            description:res.description,
            collections:res.collections,
            uploads:res.uploads,
            topics:res.topics,
            rTypes:res.rTypes,
            tags:res.tags,
            events:res.events
          })
          this.$.alertNote.innerHTML = "<div class='alert alert-success' role='alert'>Resource Uploaded</div>";

        //this.querySelector('.output').innerHTML = JSON.stringify(event.detail);
        }
      }
    });
  </script>

</dom-module>
