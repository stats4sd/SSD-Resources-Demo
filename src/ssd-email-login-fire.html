<link rel="import" href="../bower_components/polymer/polymer.html">



<dom-module id="ssd-email-login-fire">
<template>
  <style>
    :host {
      display: block;
      margin: 0 auto;
    }
    firebase-auth{
      display: none;
    }
    #reset{
      color: grey;
      text-decoration: none;
      font-size: 12px;
      font-style: italic;
      font-weight: lighter;
    }
    #reset:hover{
      color: grey;
      text-decoration: underline;
    }
    .emailPWError {
      color: var(--error-color);
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      line-height: 24px;
      margin: 0;
      padding: 0;
    }
    .emailPWMessage {
      color: var(--primary-color);
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      line-height: 24px;
      margin: 0;
      padding: 0;
    }
    form{
      min-width: 200px;
      margin: 0 auto;
    }
  </style>

  <firebase-auth app-name="{{appName}}" id="auth" user="{{user}}" signed-in="{{signedIn}}" on-error="_handleEmailPWError" status-known="{{statusKnown}}">
  </firebase-auth>

  <div>
    <div id="emailPWError"></div>
    <div id="emailPWMessage"></div>
  </div>
  <form on-submit="_signInEmailPW">
    <paper-input id="emailInput" type="email" label="Email" value="{{email}}" validator="email-validator" error-message="Invalid email address" required auto-validate></paper-input>
    <paper-input id="pwInput" type="password" label="Password" value="{{pw}}" on-keypress="_checkEnter" required></paper-input>
    <p><a href="#" id="reset" on-click="_resetPW">Reset password for entered email</a></p>
    <!--<paper-button id="emailSignUp" type="submit" on-tap="_signUpEmailPW">Sign Up</paper-button>-->
    <paper-button id="emailSignIn" type="submit" on-tap="_signInEmailPW" dialog-confirm autofocus>Sign In</paper-button>
    <paper-button id="emailSignIn" type="submit" dialog-confirm autofocus>Cancel</paper-button>
  </form>

</template>

<script>
   
    Polymer({
    is: 'ssd-email-login-fire',
      properties: {
        appName: {
          type: String
        },
        user: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
        signedIn: {
          type: Boolean,
          notify: true,
          reflectToAttribute: true
        },
        debug: {
          type: Boolean,
          value: false,
        },
        passwordResetMessage: {
          type: String,
          value:  "Password reset email has been sent. Please check your inbox."
        },
        autoSignUp: {
          type: Boolean,
          value: false
        },
        statusKnown: {
          type: Boolean,
          notify: true
        },
        email:{
          type:String
        },
        pw:{
          type:String
        }
    },
      _userChanged: function(u){
        if(typeof u !== 'undefined' && u != null){
          if (!(Object.keys(u).length === 0 && u.constructor === Object)){
            this.fire("signedin", u);
          }
        }
      },
      _cleanMessages: function(){
        this.$.emailPWError.textContent = '';
        this.$.emailPWMessage.textContent = '';
      },
      _signInEmailPW: function(e){
        this._cleanMessages();
        console.log('email password element 8',this.$.auth)
        this.$.auth.signInWithEmailAndPassword(this.email, this.pw)
          .then(function(success){
            console.log('signed in')
          })
          .catch(function(error){
            console.log('error signing in',error)
          });
      },
      _signUpEmailPW: function(e){
        this._cleanMessages();
        this.$.auth.createUserWithEmailAndPassword(this.email, this.pw);
      },
      _handleEmailPWError: function(err){
        if(err.detail.code === "auth/user-not-found" && this.autoSignUp){
          this.$.auth.createUserWithEmailAndPassword(this.email, this.pw)
          this.email = null;
          this.pw = null;
        } else {
          this.$.emailPWError.textContent = err.detail.message;
        }
      },
      _resetPW: function () {
        var that = this;
        this._cleanMessages();
        if(this.email){
          this.$.auth.sendPasswordResetEmail(this.email).then(function () {
            that.$$(".emailPWMessage").textContent = that.passwordResetMessage;
          }, function (err) {
            that.$$(".emailPWError").textContent = err.message;
          });
        } else {
          this.$.emailPWError.textContent = "Please enter a valid email address.";
        }
      },
      /**
       * Signs out the signed in user
       */
      signOut: function(){
        if(this.signedIn){this.$.auth.signOut();}
      },

      //function to check for 'enter' keypress on password field.
      _checkEnter: function(e) {
        if(e.keyCode === 13) {
          this._signInEmailPW();
        }
      }

    });
</script>
</dom-module>
