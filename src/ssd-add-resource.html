<!--See form docs at: https://elements.polymer-project.org/elements/iron-form-->

<!--import polymer html and shared styles-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-form/demo/simple-element.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">

<link rel="import" href="shared-styles.html">

<!--give id reference of page name-->
<dom-module id="ssd-add-resource">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
      
      paper-material {
        display: inline-block;
        background: white;
        box-sizing: border-box;
        width: 100%;
        margin: 8px;
        padding: 16px;
        border-radius: 2px;
      }
      .yellow-button {
        text-transform: none;
        color: #eeff41;
      }
      
      paper-progress {
        width: 100%
      }
      #collections{
        margin:0;
        z-index: 9999;
      }
      paper-checkbox{
        display:block
      }

    </style>

    <paper-material elevation="1">
      <form is="iron-form" method="get" action="/" id="basic">
        <paper-input id="resourceName" value="{{resource.name}}" name="title" label="Title of Resource" required auto-validate pattern="[a-zA-Z0-9 ']*" error-message="no special characters!"></paper-input>
         <paper-input id="resourceDescription" value="{{resource.description}}" name="description" label="Brief Description" required></paper-input>
        <paper-button raised onclick="topicsDialog.open()">Topics</paper-button>
        <paper-button raised onclick="collectionsDialog.open()">Collections</paper-button>
        <paper-button raised onclick="typeDialog.open()">Type</paper-button>
        <p>Pin to upcoming events?</p>
      </form>
      <!--error message-->
      <paper-toast id="nameWarning" duration="0" text="Give the resource title before uploading files (manually remove pending downloads)">
      <paper-button onclick="nameWarning.toggle()" class="yellow-button">OK!</paper-button>
      </paper-toast>
      <vaadin-upload id="ssdResourceUpload" files="{{uploadedFiles}}"></vaadin-upload>
      <br>
      <paper-button raised on-tap="_submit">Submit</paper-button>
      <div class="output">
    </paper-material>

    <paper-dialog id="collectionsDialog">
      <h2>Collections</h2>
      <paper-dialog-scrollable>
        <template is="dom-repeat" id="collectionCheckboxes" items="[[persistedCollections]]" as="collection">
          <paper-checkbox value="collections_-_[[collection.$val]]">{{collection.$val}}</paper-checkbox>
        </template>
      </paper-dialog-scrollable>
      <paper-button autofocus onclick="collectionsDialog.close()">Close</paper-button>
    </paper-dialog>
    
    <firebase-query id="query" app-name="SSD-Resources" path="/collections" data="{{allCollections}}"></firebase-query>
    <app-indexeddb-mirror key="persistedCollections" data="{{allCollections}}" persisted-data="{{persistedCollections}}"></app-indexeddb-mirror>
    <firebase-query id="query" app-name="SSD-Resources" path="/rTypes" data="{{allrTypes}}"></firebase-query>
    <app-indexeddb-mirror key="persistedrTypes" data="{{allrTypes}}" persisted-data="{{persistedrTypes}}"></app-indexeddb-mirror>

    <script>
    //fit toast to container
      nameWarning.fitInto = ssdResourceUpload;
      collectionsDialog.fitInto = basic;      
    </script>

    <script>
  // function _submit(event) {
  //   Polymer.dom(event).localTarget.parentElement.submit();
  //   console.log('submitted')
  // }

  //hack around vaadin upload to use firebase file put
  //can be improved on with full rewrite of vaadin-upload
  var upload1 = document.querySelector('vaadin-upload#ssdResourceUpload');
  upload1.addEventListener('upload-before', function(event) {
    event.preventDefault();  
    //check resource name exists, give warning and remove files if not
    var resourceName=document.querySelector('paper-input#resourceName').get('value')
    if(resourceName==undefined){
      var vaadinUploads=document.querySelector('vaadin-upload')
      vaadinUploads.set('files',[])
      document.querySelector('paper-toast#nameWarning').open()
      return
      }
    //create file upload task
    var file = event.detail.file;
    var ssdResourcesApp=firebase.app("SSD-Resources")
    var ref = firebase.storage(ssdResourcesApp).ref().child('uploads/'+resourceName+'/'+file.name)
    var uploadTask=ref.put(file);
    //add watch features
    uploadTask.on('state_changed',function(snapshot){
      var progressBars = document.querySelectorAll('paper-progress');
      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      var vaadinUploads=document.querySelector('vaadin-upload')
      var uploadsMeta=vaadinUploads.get('files');
      var index=_getCurrentIndex(file,uploadsMeta)
      progressBars[index].set('value',progress)
      // switch (snapshot.state) {
      //   case firebase.storage.TaskState.PAUSED: // or 'paused'
      //     break;
      //   case firebase.storage.TaskState.RUNNING: // or 'running'
      //     break;
    // }
  }, function(error) {
    console.log(error)
    // Handle unsuccessful uploads
  }, function() {
    console.log('uploadTask',uploadTask)
    // //set progress bar to complete
    var vaadinUploads=document.querySelector('vaadin-upload')
    var uploadsMeta=vaadinUploads.get('files');
    var vaadinFiles=document.querySelectorAll('vaadin-upload-file')
    var index=_getCurrentIndex(file,uploadsMeta)
    vaadinFiles[index].set('file.complete',true);
    vaadinFiles[index].set('file.loaded',100);
    //append download url to file detail - still need to ensure correct for multiple
    var downloadURL = uploadTask.snapshot.downloadURL;
    vaadinFiles[index].set('file.downloadURL',downloadURL);
    console.log('uploads meta',uploadsMeta)
    });
    });

    function _getCurrentIndex(thisFile,fileList){
      var index=-1
      for (var i=0;i<fileList.length;i++){
        var name=fileList[i].name
        if(thisFile.name==name){
          index=i
        }
      }
      return(index)
    }
  </script>

  </template>
  

  <script>  
    Polymer({
      is: 'ssd-add-resource',
      properties:{
        items:{
          type:Object,
          observer:'itemChanged'
        },
        resource:{
          type:Object,
          value:function(){return{}}
        },
        uploadedFiles:{
          type:Object,
          observer:'_uploadChange'
        }
      },
      observers:['_resourceChange(resource.name)'],

      _resourceChange:function(newValue){
         
        },
      _uploadChange:function(){
        
        },  

      checkChanged:function(){console.log(this.checked)},
      itemChanged:function(e){console.log('items changed',this.items)},

      _submit:function(){
        //should have better data binding throughout to make easier to reload and edit
        //initiate res
        var res={
          name:'',
          collections:[],
          uploads:[],
          tags:[]
        }
        //get checkbox values and assign to fields
        var checkboxes=document.querySelectorAll('paper-checkbox');
        for(var i=0;i<checkboxes.length;i++){
          if(checkboxes[i].get('checked')==true){
            var meta=checkboxes[i].get('value').split('_-_')
            var field=meta[0]
            var val = meta[1]
            res[field].push(val)
            }
        }
        //get resource name
        var name=document.querySelector('paper-input#resourceName').get('value')
        res.name=name
        //get resource files
        var uploads=document.querySelector('vaadin-upload#ssdResourceUpload').get('files')
        res.uploads=uploads
        console.log('res',res)
      //this.querySelector('.output').innerHTML = JSON.stringify(event.detail);
      }
    });
  </script>
</dom-module>