<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-elements/paper-elements.html">
<link rel="import" href="../bower_components/iron-elements/iron-elements.html">
<link rel="import" href="SSD Components/ssd-resource.html">
<link rel="import" href="SSD Components/ssd-resource-editor.html">

<dom-module id="ssd-resources">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
      .login-details{color:var(--paper-red-500)};
      /*.totallyEditable {
        border: 1px red solid;
        background-color: #ffc6cb;
      }*/
    </style>

    <div class="card">
      <h1>Resources</h1>
      <p>Welcome to the SSD Resources demo.</p>
      <p>Resources should be displayed below with some info.  Click one to learn more.</p>
      <p>To access the admin pages, please login using the padlock in the top-right of the page.</p>
      <p class="login-details">username: <strong>admin@test.com</strong><br>password: <strong>test123</strong></p>
    </div>

    <!--  SETTING UP RESOURCES -->

    <div class='row'>
      <div class='col-sm-4'>
        <h1>Filters</h1>
        <div class='card'>
          <div class='list-group'>
            <div class='list-group-item'>
              <paper-button toggles active="{{topicActive}}" raised>Filter by Topic</paper-button>
            </div>
            <iron-collapse id="topicCollapse" opened="{{topicActive}}">
              <template is="dom-repeat" items="{{topics}}">
                <div class='list-group-item'>
                  <paper-checkbox name="{{item}}" on-change='topicTapped'>{{item}}</paper-radio-button>
                </div>
              </template>
            </iron-collapse>
            <!-- rType Filter -->
            <div class='list-group-item'>
              <paper-button toggles active="{{rTypeActive}}" raised>Filter by Resource Type</paper-button>
            </div>
            <iron-collapse id="rTypeCollapse" opened="{{rTypeActive}}">
              <template is="dom-repeat" items="{{rTypes}}">
                <div class='list-group-item'>
                  <paper-checkbox name="{{item}}" on-change='rTypeTapped'>{{item}}</paper-radio-button>
                </div>
              </template>
            </iron-collapse>
            <!-- Tags filter -->
            <div class='list-group-item'>
              <paper-button toggles active="{{tagActive}}" raised>Filter by Tag</paper-button>
            </div>
            <iron-collapse id="tagCollapse" opened="{{tagActive}}">
              <template is="dom-repeat" items="{{tags}}">
                <div class='list-group-item'>
                  <paper-checkbox name="{{item}}" on-change='tagTapped'>{{item}}</paper-radio-button>
                </div>
              </template>
            </iron-collapse>
          </div>
        </div>
      </div>



      <div class='col-sm-8'>
        <h1>Resource List</h1>
        <paper-button raised class='alert alert-info' toggles active="{{editMode}}" >
          <span hidden$="{{editMode}}">Enable Editing Mode</span>
          <span hidden$="{{!editMode}}">Disable Editing Mode</span>
        </paper-button>
        <p class='alert alert-warning' hidden$="{{!editMode}}">EDIT MODE ACTIVE. Click on any of the resource cards to edit that resource.</p>
        <div class$="[[checkedView(editMode)]]">
          <template  id="resourceList" is="dom-repeat" items="{{persistedResources}}" as="resource" filter="_filter" observe="topicFilter resource.topics">
            <ssd-resource
            view="[[editMode]]"
            id$="[[resource.$key]]"
            name="[[resource.name]]"
            description="[[resource.description]]"
            topics="[[resource.topics]]"
            r-types="[[resource.rTypes]]"
            tags="[[resource.tags]]"
            uploads="[[resource.uploads]]"
            on-tap='edit'
            ></ssd-resource>
          </template>
        </div>


      </div>




      <!-- FIREBASE QUERY TO PULL IN RESOURCES FROM DB  -->
      <firebase-query id="query" app-name="SSD-Resources" path="/resources" data="{{resources}}">
      </firebase-query>
      <app-indexeddb-mirror key="persistedResources" data="{{resources}}" persisted-data="{{persistedResources}}"></app-indexeddb-mirror>

      <!-- USING FIREBASE DOCUMENTS FOR TAGS -->
      <!-- ## It might be worth changing these to queries at some point, but that's only if we can be bothered to change from using flat arrays to key-value object arrays for the tags.  Useful if we want to do things like translations later on, or include other tag "properties" beyond name. -->

      <firebase-document app="SSD-Resources" app-name="SSD-Resources" path="/topics" data="{{topics}}">
      </firebase-document>
      <app-indexeddb-mirror key="persistedTopics" data="{{topics}}" persisted-data="{{persistedTopics}}"></app-indexeddb-mirror>

      <firebase-document app="SSD-Resources" app-name="SSD-Resources" path="/rTypes" data="{{rTypes}}">
      </firebase-document>
      <app-indexeddb-mirror key="persistedRTypes" data="{{rTypes}}" persisted-data="{{persistedRTypes}}"></app-indexeddb-mirror>

      <firebase-document app="SSD-Resources" app-name="SSD-Resources" path="/tags" data="{{tags}}">
      </firebase-document>
      <app-indexeddb-mirror key="persistedTags" data="{{tags}}" persisted-data="{{persistedTags}}"></app-indexeddb-mirror>

      <firebase-document app="SSD-Resources" app-name="SSD-Resources" path="/collections" data="{{collections}}">
      </firebase-document>
      <app-indexeddb-mirror key="persistedTags" data="{{collections}}" persisted-data="{{persistedCollections}}"></app-indexeddb-mirror>

      <!--FIREBASE DOCUMENT FOR THE EDITABLE RESOURCE -->
      <firebase-document id="editingResource" app="SSD-Resources" app-name="SSD-Resources" path="[[editableResourceID]]" data="{{editableResource}}"><firebase-document>
      <!-- hidden editor (until it's not hidden...) -->

      <ssd-resource-editor
        id="editor"
        resource="{{editableResource}}"
        on-close="commitChange"
        persisted-topics="[[persistedTopics]]"
        persisted-r-types="[[persistedRTypes]]"
        persisted-tags="[[persistedTags]]"
        persisted-collections="[[persistedCollections]]">
      </ssd-resource-editor>

      <!-- ARRAY SELECTOR(S)  -->
      <array-selector id='topicSelector' items="{{topics}}" selected="{{topicFilter}}" multi toggle></array-selector>
      <array-selector id='rTypeSelector' items="{{rTypes}}" selected="{{rTypeFilter}}" multi toggle></array-selector>
      <array-selector id='tagSelector' items="{{tags}}" selected="{{tagFilter}}" multi toggle></array-selector>


  </template>

  <script>
    Polymer({
      is: 'ssd-resources',

      properties: {
        resources: {
          Object,
          observer: 'dataChanged'
        },
        obj: Object,
        topics: Object,
        topicFilter: Array,
        rTypeFilter: Array,
        tagFilter: Array,
        topicActive: {
          type: Boolean,
          value: false
        },
        rTypeActive: {
          type: Boolean,
          value: false
        },
        tagActive: {
          type: Boolean,
          value: false
        },
        signedIn: {
          type: Boolean,
          reflectToAttribute: true
        },
        editableResourceID: {
          type: String,
          notify: true
        },
        editMode: {
          type: Boolean,
          value: false
        }
      },

      checkedView: function(editMode) {
        if(editMode) {
          return "alert alert-warning"
        }
        else {
          return ""
        }
      },

      // _showEdit: function(editMode) {
      //   if(editMode) {
      //     return true
      //   } else
      //   {
      //     return false
      //   }
      // },

      dataChanged: function(newData, oldData) {
        this.$.resourceList.render();
        console.log(this.resources)
      },
      // _toArray: function(obj) {
      //       return Object.keys(obj).map(function(key) {
      //           return {
      //               name: key,
      //               value: obj[key]
      //           };
      //       });
      //   },

        _filter: function(item) {
          console.log(this.topicFilter);

          //begin by assuming you WILL show the item
          var filter = true;
          console.log(filter)

          //if a topic filter is selected...
          // // check item against every chosen topic.
          // // // if that topic is NOT present, set filter to false and return. (no more checking needed)
          if(!this.topicFilter == []) {
              for(i=0; i<this.topicFilter.length; i++) {
                if(item.topics == [] || item.topics == undefined )
                {
                  filter = false;
                  return;
                }
                else if (item.topics.indexOf(this.topicFilter[i])== -1) {
                  filter = false;
                  return filter;
              }
            }
          }
          console.log(filter)

          //Do the same for resource type...
          if(!this.rTypeFilter == []) {
              for(i=0; i<this.rTypeFilter.length; i++) {
                if(item.rTypes == [] || item.rTypes == undefined ) {
                  filter = false;
                  return filter;
                }
                else if(item.rTypes.indexOf(this.rTypeFilter[i])== -1) {
                  filter = false;
                  return filter;
              }
            }
          }
          //... and tags
          if(!this.tagFilter == []) {
              for(i=0; i<this.tagFilter.length; i++) {
                if(item.tags == [] || item.tags == undefined  ) {
                  filter = false;
                  return filter;
                }
                else if(item.tags.indexOf(this.tagFilter[i])== -1) {
                  filter = false;
                  return filter;
              }
            }
          }
          //If you reach this point, the item matches all selected filters, so just return.
          return filter;
        },


        //When selecting an item from the Topic Filters list
        topicTapped: function(event) {
          //grab the correct filter text
          var res = event.target.innerText || event.target.textContent;
          //and use select() on the arraySelector to toggle the filter on or off
          this.$.topicSelector.select(res);
          console.log(this.topicFilter);
          //finally, tell the dom-repeat resource list to re-render (needed to trigger the _filter again)
          this.$.resourceList.render();
        },

        //When selecting an item from the rType Filters list
        rTypeTapped: function(event) {
          //grab the correct filter text
          var res = event.target.innerText || event.target.textContent;
          //and use select() on the arraySelector to toggle the filter on or off
          this.$.rTypeSelector.select(res);
          console.log(this.rTypeFilter);
          //finally, tell the dom-repeat resource list to re-render (needed to trigger the _filter again)
          this.$.resourceList.render();
        },

        //When selecting an item from the tag Filters list
        tagTapped: function(event) {
          //grab the correct filter text
          var res = event.target.innerText || event.target.textContent;
          //and use select() on the arraySelector to toggle the filter on or off
          this.$.tagSelector.select(res);
          console.log(this.tagFilter);
          //finally, tell the dom-repeat resource list to re-render (needed to trigger the _filter again)
          this.$.resourceList.render();
        },

        //Next bits rely heavily on pasted code from notes-app...

        edit: function(event) {
          if(this.editMode) {
            var card = Polymer.dom(event).localTarget;
            console.log(card);
            console.log(card.id)
            console.log("tapped to edit");
            this.editableResourceID = "/resources/"+card.id;
            console.log(this.editableResourceID)
            this.$.editingResource.transactionsComplete.then(function() {
              console.log(this.editableResource)

              this.$.editor.open(card);
            }.bind(this));
          }

        }
    }


  );
  </script>
</dom-module>
